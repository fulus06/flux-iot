# FLUX IOT å¤šåè®®åª’ä½“æ¥å…¥æ¶æ„è®¾è®¡

## 1. æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    flux-server (ç½‘å…³å±‚)                          â”‚
â”‚  - ç»Ÿä¸€ API ç½‘å…³                                                 â”‚
â”‚  - é‰´æƒ/å®¡è®¡/è·¯ç”±èšåˆ                                            â”‚
â”‚  - å¤šç§Ÿæˆ·ç®¡ç†                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åè®®æ¥å…¥å±‚ (Protocol Daemons)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ GB28181d â”‚ â”‚  RTMPd   â”‚ â”‚  RTSPd   â”‚ â”‚ WebRTCd  â”‚  ...     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   SRTd   â”‚ â”‚   FLVd   â”‚ â”‚  ONVIFd  â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              flux-media-core (åè®®æ— å…³åª’ä½“å±‚)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  MediaStorage    â”‚  â”‚  SnapshotOrchestrator    â”‚           â”‚
â”‚  â”‚  - FileSystem    â”‚  â”‚  - Keyframe/Decode       â”‚           â”‚
â”‚  â”‚  - S3/OSS        â”‚  â”‚  - Cache/Fallback        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Transcoder      â”‚  â”‚  StreamOrchestrator      â”‚           â”‚
â”‚  â”‚  - FFmpeg        â”‚  â”‚  - æµç®¡ç†/è·¯ç”±           â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. åè®®åˆ†ç±»ä¸ä¼˜å…ˆçº§

### 2.1 æ¨æµåè®®ï¼ˆIngestï¼‰

| åè®® | ä¼˜å…ˆçº§ | å¤æ‚åº¦ | ç”¨é€” | å®ç°æ–¹æ¡ˆ |
|------|--------|--------|------|----------|
| **RTMP** | P0 | ä¸­ | ç›´æ’­æ¨æµ | flux-rtmpd + rtmp crate |
| **RTSP** | P0 | ä¸­ | æ‘„åƒå¤´æ‹‰æµ | flux-rtspd + rtsp-rs |
| **GB28181** | P0 | é«˜ | å›½æ ‡æ‘„åƒå¤´ | âœ… å·²å®Œæˆ |
| **SRT** | P1 | ä¸­ | ä½å»¶è¿Ÿä¼ è¾“ | flux-srtd + srt-rs |
| **WebRTC** | P1 | é«˜ | æµè§ˆå™¨æ¨æµ | flux-webrtcd + webrtc-rs |
| **ONVIF** | P2 | é«˜ | IP æ‘„åƒå¤´ç®¡ç† | flux-onvifd + onvif-rs |

### 2.2 æ’­æ”¾åè®®ï¼ˆPlaybackï¼‰

| åè®® | ä¼˜å…ˆçº§ | å¤æ‚åº¦ | ç”¨é€” | å®ç°æ–¹æ¡ˆ |
|------|--------|--------|------|----------|
| **HLS** | P0 | ä½ | HTTP ç›´æ’­ | flux-media-core + m3u8 ç”Ÿæˆ |
| **FLV** | P0 | ä½ | HTTP-FLV ç›´æ’­ | flux-media-core + flv å°è£… |
| **RTMP** | P1 | ä¸­ | RTMP æ’­æ”¾ | flux-rtmpd åŒå‘æ”¯æŒ |
| **WebRTC** | P1 | é«˜ | è¶…ä½å»¶è¿Ÿæ’­æ”¾ | flux-webrtcd åŒå‘æ”¯æŒ |

## 3. æ ¸å¿ƒæŠ½è±¡è®¾è®¡

### 3.1 ProtocolAdapter Trait

```rust
use async_trait::async_trait;
use flux_media_core::types::{StreamId, VideoSample, AudioSample};

#[async_trait]
pub trait ProtocolAdapter: Send + Sync {
    /// åè®®åç§°
    fn protocol_name(&self) -> &str;
    
    /// å¯åŠ¨åè®®æœåŠ¡
    async fn start(&self) -> Result<()>;
    
    /// åœæ­¢åè®®æœåŠ¡
    async fn stop(&self) -> Result<()>;
    
    /// æ³¨å†Œæµå¤„ç†å›è°ƒ
    fn on_stream_ready(&self, callback: Box<dyn StreamCallback>);
    
    /// è·å–åè®®ç»Ÿè®¡ä¿¡æ¯
    async fn stats(&self) -> ProtocolStats;
}

#[async_trait]
pub trait StreamCallback: Send + Sync {
    async fn on_video_sample(&self, stream_id: &StreamId, sample: VideoSample);
    async fn on_audio_sample(&self, stream_id: &StreamId, sample: AudioSample);
    async fn on_stream_closed(&self, stream_id: &StreamId);
}
```

### 3.2 StreamOrchestratorï¼ˆæµç¼–æ’å™¨ï¼‰

```rust
pub struct StreamOrchestrator {
    storage: Arc<dyn MediaStorage>,
    snapshot: Arc<SnapshotOrchestrator>,
    transcoder: Option<Arc<dyn Transcoder>>,
    active_streams: Arc<RwLock<HashMap<StreamId, StreamContext>>>,
}

impl StreamOrchestrator {
    /// æ³¨å†Œæ–°æµ
    pub async fn register_stream(&self, stream_id: StreamId, protocol: &str) -> Result<()>;
    
    /// å¤„ç†è§†é¢‘æ ·æœ¬
    pub async fn process_video(&self, stream_id: &StreamId, sample: VideoSample) -> Result<()>;
    
    /// å¤„ç†éŸ³é¢‘æ ·æœ¬
    pub async fn process_audio(&self, stream_id: &StreamId, sample: AudioSample) -> Result<()>;
    
    /// è·å–æµçŠ¶æ€
    pub async fn get_stream_status(&self, stream_id: &StreamId) -> Option<StreamStatus>;
}
```

## 4. åè®®å®ç°è·¯çº¿å›¾

### Phase 1: æ ¸å¿ƒæ¨æµåè®®ï¼ˆ2-3 å‘¨ï¼‰

#### 4.1 RTMP æ”¯æŒï¼ˆflux-rtmpdï¼‰
- **ä¾èµ–**: `rtmp-rs` æˆ– `rml_rtmp`
- **åŠŸèƒ½**:
  - RTMP æ¨æµæ¥æ”¶ï¼ˆpublishï¼‰
  - RTMP æ’­æ”¾ï¼ˆplayï¼‰
  - FLV è§£å¤ç”¨ â†’ H264/AAC
  - é›†æˆ flux-media-core
- **API**:
  ```
  rtmp://server:1935/live/stream_name
  ```

#### 4.2 RTSP æ”¯æŒï¼ˆflux-rtspdï¼‰
- **ä¾èµ–**: `rtsp-rs` æˆ–è‡ªç ”
- **åŠŸèƒ½**:
  - RTSP DESCRIBE/SETUP/PLAY
  - RTP/RTCP å¤„ç†
  - H264/H265 è§£åŒ…
  - é›†æˆ flux-media-core
- **API**:
  ```
  rtsp://server:554/live/stream_name
  ```

### Phase 2: æ’­æ”¾åè®®ï¼ˆ1-2 å‘¨ï¼‰

#### 4.3 HLS æ”¯æŒ
- **å®ç°**: åŸºäº flux-media-core çš„å­˜å‚¨
- **åŠŸèƒ½**:
  - M3U8 æ’­æ”¾åˆ—è¡¨ç”Ÿæˆ
  - TS åˆ†ç‰‡ç”Ÿæˆ
  - è‡ªé€‚åº”ç ç‡ï¼ˆå¯é€‰ï¼‰
- **API**:
  ```
  GET /hls/{stream_id}/index.m3u8
  GET /hls/{stream_id}/segment_{n}.ts
  ```

#### 4.4 HTTP-FLV æ”¯æŒ
- **å®ç°**: åŸºäº flux-media-core
- **åŠŸèƒ½**:
  - FLV å°è£…
  - HTTP chunked ä¼ è¾“
  - ä½å»¶è¿Ÿä¼˜åŒ–
- **API**:
  ```
  GET /flv/{stream_id}.flv
  ```

### Phase 3: é«˜çº§åè®®ï¼ˆ3-4 å‘¨ï¼‰

#### 4.5 SRT æ”¯æŒï¼ˆflux-srtdï¼‰
- **ä¾èµ–**: `srt-rs` æˆ– FFI ç»‘å®š
- **åŠŸèƒ½**:
  - SRT listener/caller
  - ä½å»¶è¿Ÿä¼ è¾“
  - ä¸¢åŒ…é‡ä¼ 
  - é›†æˆ flux-media-core

#### 4.6 WebRTC æ”¯æŒï¼ˆflux-webrtcdï¼‰
- **ä¾èµ–**: `webrtc-rs`
- **åŠŸèƒ½**:
  - WebRTC ä¿¡ä»¤ï¼ˆSDP äº¤æ¢ï¼‰
  - DTLS/SRTP
  - ICE/STUN/TURN
  - è¶…ä½å»¶è¿Ÿï¼ˆ< 500msï¼‰

#### 4.7 ONVIF æ”¯æŒï¼ˆflux-onvifdï¼‰
- **ä¾èµ–**: `onvif-rs`
- **åŠŸèƒ½**:
  - è®¾å¤‡å‘ç°ï¼ˆWS-Discoveryï¼‰
  - PTZ æ§åˆ¶
  - äº‹ä»¶è®¢é˜…
  - ä¸ RTSP é›†æˆ

## 5. ç»Ÿä¸€ API è®¾è®¡

### 5.1 æ¨æµ API

```http
POST /api/v1/streams/ingest
{
  "protocol": "rtmp|rtsp|gb28181|srt|webrtc",
  "stream_id": "custom_stream_id",
  "source": {
    "rtmp": { "app": "live", "stream": "test" },
    "rtsp": { "url": "rtsp://camera/stream" },
    "gb28181": { "device_id": "xxx", "channel_id": "yyy" }
  }
}
```

### 5.2 æ’­æ”¾ API

```http
GET /api/v1/streams/{stream_id}/play?protocol=hls|flv|rtmp|webrtc
```

### 5.3 Snapshot APIï¼ˆåè®®æ— å…³ï¼‰

```http
GET /api/v1/streams/{stream_id}/snapshot?mode=auto|keyframe|decode&width=640&height=480
```

### 5.4 æµç®¡ç† API

```http
GET  /api/v1/streams                    # åˆ—å‡ºæ‰€æœ‰æµ
GET  /api/v1/streams/{stream_id}        # è·å–æµè¯¦æƒ…
POST /api/v1/streams/{stream_id}/stop   # åœæ­¢æµ
GET  /api/v1/streams/{stream_id}/stats  # æµç»Ÿè®¡
```

## 6. é…ç½®ç¤ºä¾‹

```toml
[protocols]
enabled = ["rtmp", "rtsp", "gb28181", "hls", "flv"]

[protocols.rtmp]
bind = "0.0.0.0:1935"
chunk_size = 4096
max_connections = 1000

[protocols.rtsp]
bind = "0.0.0.0:554"
transport = ["tcp", "udp"]
rtp_port_range = "10000-20000"

[protocols.gb28181]
bind_sip = "0.0.0.0:5060"
bind_rtp = "0.0.0.0:9000"
sip_domain = "3402000000"

[protocols.hls]
segment_duration = 6
playlist_length = 5
enable_adaptive = false

[protocols.flv]
enable = true
chunk_size = 4096

[media]
storage_dir = "/var/lib/flux-media/storage"
keyframe_dir = "/var/lib/flux-media/keyframes"
retention_days = 7
```

## 7. æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | è¯´æ˜ |
|------|------|------|
| **å¹¶å‘æµæ•°** | 1000+ | å•å®ä¾‹æ”¯æŒ |
| **å»¶è¿Ÿï¼ˆRTMP/RTSPï¼‰** | < 2s | ç«¯åˆ°ç«¯å»¶è¿Ÿ |
| **å»¶è¿Ÿï¼ˆHLSï¼‰** | < 10s | æ ‡å‡† HLS |
| **å»¶è¿Ÿï¼ˆWebRTCï¼‰** | < 500ms | è¶…ä½å»¶è¿Ÿ |
| **CPU å ç”¨** | < 50% | 1000 æµåœºæ™¯ |
| **å†…å­˜å ç”¨** | < 4GB | 1000 æµåœºæ™¯ |

## 8. æŠ€æœ¯æ ˆé€‰å‹

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç†ç”± |
|------|----------|------|
| **RTMP** | rml_rtmp | æˆç†Ÿçš„ Rust RTMP åº“ |
| **RTSP** | rtsp-rs | è½»é‡çº§ RTSP å®ç° |
| **WebRTC** | webrtc-rs | å®˜æ–¹ WebRTC åº“ |
| **SRT** | srt-tokio | Tokio é›†æˆ |
| **HLS/FLV** | è‡ªç ” | åŸºäº flux-media-core |
| **è½¬ç ** | FFmpeg (FFI) | å·¥ä¸šæ ‡å‡† |

## 9. éƒ¨ç½²æ¶æ„

### 9.1 å•æœºéƒ¨ç½²
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         flux-server (ç½‘å…³)           â”‚
â”‚  - HTTP API                         â”‚
â”‚  - é‰´æƒ/è·¯ç”±                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    flux-media-gateway (åè®®èšåˆ)     â”‚
â”‚  - RTMP/RTSP/GB28181/...            â”‚
â”‚  - flux-media-core                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 åˆ†å¸ƒå¼éƒ¨ç½²
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ flux-rtmpd  â”‚  â”‚ flux-rtspd  â”‚  â”‚flux-gb28181dâ”‚
â”‚ (RTMP ä¸“ç”¨) â”‚  â”‚ (RTSP ä¸“ç”¨) â”‚  â”‚ (GB28181)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  flux-server    â”‚
              â”‚  (ç½‘å…³/èšåˆ)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 10. ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¼€å§‹ï¼ˆæœ¬å‘¨ï¼‰
1. âœ… å®Œæˆ flux-media-core åŸºç¡€æ¶æ„
2. âœ… é‡æ„ flux-gb28181d ä½¿ç”¨ flux-media-core
3. ğŸ”„ å®ç° flux-rtmpdï¼ˆRTMP æ¨æµï¼‰
4. ğŸ”„ å®ç° HLS/FLV æ’­æ”¾æ”¯æŒ

### çŸ­æœŸç›®æ ‡ï¼ˆ2-4 å‘¨ï¼‰
5. å®ç° flux-rtspdï¼ˆRTSP æ‹‰æµï¼‰
6. å®Œå–„ HLS è‡ªé€‚åº”ç ç‡
7. æ·»åŠ è½¬ç æ”¯æŒï¼ˆFFmpeg é›†æˆï¼‰

### ä¸­æœŸç›®æ ‡ï¼ˆ1-2 æœˆï¼‰
8. å®ç° WebRTC æ”¯æŒ
9. å®ç° SRT æ”¯æŒ
10. å®ç° ONVIF è®¾å¤‡ç®¡ç†

### é•¿æœŸç›®æ ‡ï¼ˆ3+ æœˆï¼‰
11. é›†ç¾¤åŒ–éƒ¨ç½²æ”¯æŒ
12. è¾¹ç¼˜èŠ‚ç‚¹æ”¯æŒ
13. AI è§†é¢‘åˆ†æé›†æˆ
