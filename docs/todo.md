# FLUX IOT 待办事项清单

## 🔥 高优先级任务

### 1. 协议层功能完善

#### 1.1 RTSP 协议（完成度 100%）🎉✅
- [x] DESCRIBE/SETUP/PLAY 信令实现
- [x] RTP 接收和解析
- [x] H264 RTP 解包（单包/STAP-A/FU-A）
- [x] H265 RTP 解包（单包/AP/FU）
- [x] AAC 音频解包（RFC 3640）
- [x] RTCP 支持（SR/RR 报文、丢包统计、抖动）
- [x] TCP 传输模式（RTP over TCP Interleaved）
- [x] UDP 多播支持（IGMP 协议集成）
- [x] 拉流管理和会话控制
- [x] Telemetry 集成（stream_start/stop, write_ok/err）
- [x] 完整测试覆盖（17 个单元测试）

> **注意**：TCP 多播在技术上不存在（TCP 是点对点协议），只有 UDP 多播。
> **状态**：RTSP 协议已 100% 完成，生产就绪！

#### 1.2 SRT 协议（完成度 25% → 目标 100%）
**实施策略**：从头实现完整 SRT 协议  
**预计工期**：4-6 周 | **详细规划**：`docs/srt_protocol_plan.md`

**当前状态（25%）**：
- [x] 项目框架搭建
- [x] SRT 包结构（数据包/控制包）
- [x] SRT 握手协议（4 次握手）
- [x] 握手状态机
- [x] HTTP API 基础
- [x] Telemetry 集成
- [x] 9 个单元测试通过

**集成计划（目标 90%+）**：

**阶段 1：依赖集成** - 2-3 天
- [ ] 添加 srt-tokio 依赖
- [ ] 移除旧的简化实现
- [ ] 创建新模块结构

**阶段 2：Listener 实现** - 3-4 天
- [ ] 封装 srt-tokio Listener
- [ ] 集成到 HTTP API
- [ ] 与 FFmpeg 互操作测试

**阶段 3：Sender 实现** - 2-3 天
- [ ] 封装 srt-tokio Sender
- [ ] 添加发送 API
- [ ] 端到端测试

**阶段 4：高级特性** - 2-3 天
- [ ] 统计信息收集
- [ ] Telemetry 完整集成
- [ ] 配置参数支持（延迟、加密）

**阶段 5：测试和文档** - 1-2 天
- [ ] 集成测试
- [ ] 与 OBS/FFmpeg 互操作验证
- [ ] API 文档

> **核心优势**：
> - ✅ 功能完整（Listen/Connect/Rendezvous/ARQ/TsbPd/加密）
> - ✅ 纯 Rust 实现，无 unsafe 代码
> - ✅ 基于 Tokio，高性能异步
> - ✅ 活跃维护，社区支持
> 
> **参考库**：[srt-rs](https://github.com/russelltg/srt-rs) - 16 贡献者，5 个版本

### 2. 配置管理

#### 2.1 动态配置热更新
- [ ] 统一 ConfigManager 实现
- [ ] watch channel + reload 机制
- [ ] 支持 file/sqlite/postgres 触发方式
- [ ] 配置热更新（无需重启）
- [ ] 配置格式校验和冲突检测
- [ ] 配置回滚机制

> **设计方案**：
> 1. **机制设计**：统一 `ConfigManager`（内部 watch channel + reload），支持 file/sqlite/postgres 三类触发方式；
> 2. **最小落地改造**：不大改你现有业务代码，只把 `AppState.config` 从"固定值"升级为"可读最新快照的句柄"（例如 `watch::Receiver<AppConfig>`），并提供一个 `state.config()` 便捷读取方法。

### 3. 生产环境特性

#### 3.1 监控和告警完善
- [ ] Prometheus 指标完善（延迟分位数、吞吐量、资源使用率）
- [ ] Grafana Dashboard 模板
- [ ] 实时告警规则引擎
- [ ] 多通知渠道（webhook、邮件、钉钉）
- [ ] 告警聚合与降噪

#### 3.2 日志增强
- [ ] 结构化日志（JSON Lines）
- [ ] 日志采样（高频日志降噪）
- [ ] 日志聚合和查询
- [ ] 分布式追踪（OpenTelemetry 集成）
- [ ] trace_id/span_id 关联

#### 3.3 优雅关闭
- [ ] 信号处理（SIGTERM/SIGINT）
- [ ] 连接排空（drain）
- [ ] 资源清理
- [ ] 状态持久化

### 4. 数据库连接池优化
- [ ] 根据负载动态调整连接数
- [ ] 添加连接池监控指标
- [ ] 实现连接预热机制

---

## 🟡 中优先级任务

### 5. 媒体功能增强

#### 5.1 HLS/FLV 完善
- [ ] TS 分片生成优化
- [ ] HTTP-FLV 流式传输
- [ ] 自适应码率（ABR）
- [ ] 多码率切换

#### 5.2 时移回放（TimeShift）
- [ ] 时移索引管理
- [ ] 快速定位和跳转
- [ ] 时移播放 API
- [ ] 时移缓存策略

#### 5.3 转码功能
- [ ] 实时转码（H264/H265）
- [ ] 音频转码（AAC/MP3）
- [ ] 分辨率调整
- [ ] 码率控制

### 6. 安全加固

#### 6.1 认证授权
- [ ] JWT Token 认证
- [ ] RBAC 权限控制
- [ ] API Key 管理
- [ ] OAuth2 集成

#### 6.2 传输安全
- [ ] TLS/SSL 支持
- [ ] 证书管理
- [ ] 加密传输（SRTP/DTLS）

#### 6.3 审计日志
- [ ] 操作审计记录
- [ ] 访问日志
- [ ] 安全事件追踪

### 7. Web UI 管理界面
- [ ] 设备管理界面
- [ ] 流管理界面
- [ ] 规则配置界面
- [ ] 监控大屏
- [ ] 日志查询界面

### 8. 容器化和部署
- [ ] Docker 镜像构建
- [ ] Docker Compose 编排
- [ ] Kubernetes 部署清单
- [ ] Helm Chart
- [ ] CI/CD 流水线

---

## 🟢 低优先级任务

### 9. 高级协议支持

#### 9.1 WebRTC 协议（完成度 0%）
- [ ] ICE/STUN/TURN 支持
- [ ] SDP 协商
- [ ] 浏览器推流/播放
- [ ] P2P 连接管理

#### 9.2 ONVIF 协议（完成度 0%）
- [ ] 设备发现（WS-Discovery）
- [ ] 设备管理接口
- [ ] PTZ 控制
- [ ] 事件订阅

### 10. 集群和扩展性

#### 10.1 负载均衡
- [ ] 流媒体负载均衡
- [ ] 会话保持
- [ ] 健康检查

#### 10.2 分布式存储
- [ ] 对象存储集成（S3/OSS/MinIO）
- [ ] 分布式缓存（Redis）
- [ ] 存储分片策略

#### 10.3 边缘节点
- [ ] 边缘推流节点
- [ ] 边缘播放节点
- [ ] 中心-边缘同步

### 11. 性能优化

#### 11.1 压力测试
- [ ] 并发推流测试
- [ ] 并发播放测试
- [ ] 长时间稳定性测试
- [ ] 性能基准测试

#### 11.2 内存优化
- [ ] 内存池管理
- [ ] 零拷贝优化扩展
- [ ] 内存泄漏检测

#### 11.3 并发优化
- [ ] 线程池调优
- [ ] 异步任务优化
- [ ] 锁竞争优化

---

## Telemetry 系统下一步可选方向

### 1. 扩展 telemetry 覆盖面
- [ ] RTSP/SRT 服务的关键事件上报
  - 流启动/停止事件（`stream/start`, `stream/stop`）
  - 连接建立/断开事件
  - 转码/编解码性能指标
- [ ] 增加更多业务事件
  - GB28181 设备上下线事件
  - 快照提取成功/失败事件
  - 时移回放请求事件

### 2. 增强可观测性
- [ ] 分布式追踪集成
  - 添加 trace ID 关联多个事件
  - OpenTelemetry 集成（trace + span）
  - 跨服务调用链追踪
- [ ] 更多 Prometheus 指标
  - 请求延迟分位数（P50/P95/P99）
  - 吞吐量指标（帧率、码率）
  - 资源使用率（CPU、内存、磁盘 I/O）
- [ ] 日志结构化增强
  - 统一日志格式（JSON Lines）
  - 关联 trace_id/span_id
  - 支持日志采样（高频日志降噪）

### 3. 运维工具与自动化
- [ ] 实时告警规则引擎
  - 基于 telemetry 事件的规则匹配
  - 支持多种通知渠道（webhook、邮件、钉钉）
  - 告警聚合与降噪（防止告警风暴）
- [ ] Dashboard 数据源接口
  - Grafana 数据源插件
  - 预定义监控面板模板
  - 实时指标查询 API
- [ ] 自动化故障诊断
  - 根据错误模式给出诊断建议
  - 关联历史故障案例
  - 自动生成故障报告

### 4. 性能优化
- [ ] Telemetry 批量上报
  - 客户端缓冲 + 批量发送
  - 降低网络开销
- [ ] 时序数据库集成
  - InfluxDB/TimescaleDB 存储长期指标
  - 支持高效的时间范围查询
- [ ] 事件流处理
  - Kafka/Pulsar 集成
  - 实时流式分析
