# FLUX IOT ä»£ç è´¨é‡æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜ FLUX IOT é¡¹ç›®çš„ä»£ç è´¨é‡æ ‡å‡†ã€å·¥å…·é…ç½®å’Œæœ€ä½³å®è·µã€‚

---

## 1. ä»£ç è§„èŒƒ

### 1.1 æ ¸å¿ƒåŸåˆ™
- âœ… **é›¶ `unwrap()` / `expect()`**: æ‰€æœ‰é”™è¯¯å¿…é¡»ä¼˜é›…å¤„ç†
- âœ… **é›¶ç¼–è¯‘è­¦å‘Š**: å¿…é¡»é€šè¿‡ `cargo clippy` ä¸¥æ ¼æ£€æŸ¥
- âœ… **ç»Ÿä¸€é”™è¯¯ç±»å‹**: ä½¿ç”¨ `thiserror` å®šä¹‰ç»“æ„åŒ–é”™è¯¯
- âœ… **å†…å­˜å®‰å…¨**: éµå¾ª Rust æ‰€æœ‰æƒå’Œå€Ÿç”¨è§„åˆ™
- âœ… **é›¶æˆæœ¬æŠ½è±¡**: æ€§èƒ½ä¼˜å…ˆï¼Œé¿å…ä¸å¿…è¦çš„è¿è¡Œæ—¶å¼€é”€

### 1.2 å‘½åè§„èŒƒ
```rust
// âœ… å¥½ï¼šæ¸…æ™°çš„å‘½å
pub struct PluginManager { ... }
pub fn load_plugin(&self, plugin_id: &str) -> Result<()> { ... }

// âŒ åï¼šæ¨¡ç³Šçš„å‘½å
pub struct PM { ... }
pub fn load(&self, id: &str) -> Result<()> { ... }
```

### 1.3 æ³¨é‡Šè§„èŒƒ
```rust
// âœ… å¥½ï¼šè§£é‡Š"ä¸ºä»€ä¹ˆ"
// ä½¿ç”¨ Arc å…±äº«æ¨¡å—ï¼Œé¿å…æ¯æ¬¡å®ä¾‹åŒ–æ—¶é‡æ–°ç¼–è¯‘
let module = Arc::new(self.host.load_module(wasm_bytes)?);

// âŒ åï¼šé‡å¤ä»£ç å†…å®¹
// åˆ›å»º Arc
let module = Arc::new(self.host.load_module(wasm_bytes)?);
```

---

## 2. é”™è¯¯å¤„ç†

### 2.1 ç»Ÿä¸€é”™è¯¯ç±»å‹

ä½¿ç”¨ `thiserror` å®šä¹‰é¡¹ç›®çº§é”™è¯¯ï¼š

```rust
use thiserror::Error;

#[derive(Error, Debug)]
pub enum FluxError {
    #[error("EventBus error: {0}")]
    EventBus(String),
    
    #[error("Plugin error: {0}")]
    Plugin(String),
    
    #[error("Serialization error: {0}")]
    Serialization(#[from] serde_json::Error),
    
    #[error("Database error: {0}")]
    Database(#[from] sea_orm::DbErr),
}

pub type Result<T> = std::result::Result<T, FluxError>;
```

### 2.2 é”™è¯¯ä¼ æ’­

```rust
// âœ… å¥½ï¼šä½¿ç”¨ ? æ“ä½œç¬¦
pub fn load_plugin(&self, plugin_id: &str, wasm_bytes: &[u8]) -> Result<()> {
    let module = self.host.load_module(wasm_bytes)?;
    // ...
    Ok(())
}

// âŒ åï¼šä½¿ç”¨ unwrap
pub fn load_plugin(&self, plugin_id: &str, wasm_bytes: &[u8]) {
    let module = self.host.load_module(wasm_bytes).unwrap(); // å±é™©ï¼
}
```

### 2.3 é”™è¯¯ä¸Šä¸‹æ–‡

```rust
use anyhow::Context;

// âœ… å¥½ï¼šæ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
let instance = linker.instantiate(&mut store, &module)
    .context("Failed to instantiate plugin")?;

// âŒ åï¼šä¸¢å¤±é”™è¯¯ä¸Šä¸‹æ–‡
let instance = linker.instantiate(&mut store, &module)?;
```

---

## 3. ä»£ç æ ¼å¼åŒ–

### 3.1 ä½¿ç”¨ rustfmt

```bash
# æ ¼å¼åŒ–æ‰€æœ‰ä»£ç 
cargo fmt --all

# æ£€æŸ¥æ ¼å¼ï¼ˆCI ä¸­ä½¿ç”¨ï¼‰
cargo fmt --all -- --check
```

### 3.2 rustfmt é…ç½®

é¡¹ç›®ä½¿ç”¨é»˜è®¤ `rustfmt` é…ç½®ï¼Œå…³é”®è®¾ç½®ï¼š
- **max_width**: 100
- **tab_spaces**: 4
- **edition**: 2021

---

## 4. Clippy æ£€æŸ¥

### 4.1 è¿è¡Œ Clippy

```bash
# æ£€æŸ¥æ‰€æœ‰ç›®æ ‡ï¼ˆåŒ…æ‹¬æµ‹è¯•ï¼‰
cargo clippy --all-targets

# ä¸¥æ ¼æ¨¡å¼ï¼ˆè­¦å‘Šè§†ä¸ºé”™è¯¯ï¼‰
cargo clippy --all-targets -- -D warnings
```

### 4.2 å¸¸è§ Clippy è§„åˆ™

#### ç¦æ­¢å¸ƒå°”æ¯”è¾ƒ
```rust
// âŒ å
assert_eq!(result, true);

// âœ… å¥½
assert!(result);
```

#### é¿å…æ¨¡å—é‡å
```rust
// âŒ å
#[cfg(test)]
mod tests {
    mod tests { ... } // é‡å¤ï¼
}

// âœ… å¥½
#[cfg(test)]
mod test_module {
    // ...
}
```

#### æœªä½¿ç”¨çš„å¯¼å…¥
```rust
// âŒ å
use super::*; // å¯èƒ½å¯¼å…¥æœªä½¿ç”¨çš„é¡¹

// âœ… å¥½
use crate::ScriptEngine;
use flux_types::message::Message;
```

---

## 5. Git Hooks

### 5.1 å®‰è£… Hooks

```bash
# ä¸€é”®å®‰è£…
./scripts/setup-hooks.sh
```

### 5.2 Pre-commit Hook

**è§¦å‘æ—¶æœº**: æ¯æ¬¡ `git commit` å‰

**æ£€æŸ¥é¡¹**:
1. âœ… ä»£ç æ ¼å¼åŒ–æ£€æŸ¥ (`cargo fmt --check`)
2. âœ… Clippy æ£€æŸ¥ (`cargo clippy -D warnings`)
3. âœ… å•å…ƒæµ‹è¯• (`cargo test --workspace`)

**è·³è¿‡æ–¹å¼**:
```bash
# ç´§æ€¥æƒ…å†µä¸‹è·³è¿‡ï¼ˆä¸æ¨èï¼‰
git commit --no-verify
```

### 5.3 Pre-push Hook

**è§¦å‘æ—¶æœº**: æ¯æ¬¡ `git push` å‰

**æ£€æŸ¥é¡¹**:
1. âœ… å®Œæ•´æµ‹è¯•å¥—ä»¶
2. âœ… Release æ„å»ºæ£€æŸ¥
3. âœ… Cargo check

---

## 6. æµ‹è¯•è§„èŒƒ

### 6.1 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | å½“å‰çŠ¶æ€ |
|------|-----------|---------|
| flux-core | > 80% | âœ… 85% |
| flux-plugin | > 80% | âœ… 82% |
| flux-script | > 70% | âœ… 75% |
| flux-server | > 70% | âœ… 73% |

### 6.2 æµ‹è¯•å‘½åè§„èŒƒ

```rust
#[cfg(test)]
mod plugin_tests {  // ä½¿ç”¨æè¿°æ€§æ¨¡å—å
    use super::*;
    
    #[test]
    fn test_load_plugin_success() {  // test_ å‰ç¼€ + åŠ¨ä½œ + é¢„æœŸç»“æœ
        // ...
    }
    
    #[test]
    fn test_load_invalid_wasm() {
        // ...
    }
}
```

### 6.3 æµ‹è¯•ç»“æ„

```rust
#[test]
fn test_feature_name() {
    // 1. Arrangeï¼ˆå‡†å¤‡ï¼‰
    let manager = PluginManager::new().unwrap();
    let wasm_bytes = load_test_wasm();
    
    // 2. Actï¼ˆæ‰§è¡Œï¼‰
    let result = manager.load_plugin("test", &wasm_bytes);
    
    // 3. Assertï¼ˆæ–­è¨€ï¼‰
    assert!(result.is_ok());
}
```

---

## 7. æŒç»­é›†æˆï¼ˆCIï¼‰

### 7.1 CI æµç¨‹

```yaml
# .github/workflows/ci.yml ç¤ºä¾‹
name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      
      # æ ¼å¼æ£€æŸ¥
      - run: cargo fmt --all -- --check
      
      # Clippy æ£€æŸ¥
      - run: cargo clippy --all-targets -- -D warnings
      
      # æµ‹è¯•
      - run: cargo test --workspace
      
      # æ„å»º
      - run: cargo build --release
```

### 7.2 å¾½ç« 

```markdown
![CI Status](https://github.com/your-org/flux-iot/workflows/CI/badge.svg)
![Coverage](https://codecov.io/gh/your-org/flux-iot/branch/main/graph/badge.svg)
```

---

## 8. ä»£ç å®¡æŸ¥æ¸…å•

### 8.1 æäº¤å‰è‡ªæŸ¥

- [ ] ä»£ç å·²æ ¼å¼åŒ– (`cargo fmt`)
- [ ] é€šè¿‡ Clippy æ£€æŸ¥ (`cargo clippy`)
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ (`cargo test`)
- [ ] æ·»åŠ å¿…è¦çš„æµ‹è¯•ç”¨ä¾‹
- [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£
- [ ] æ— ç¼–è¯‘è­¦å‘Š
- [ ] æ—  `unwrap()` / `expect()`

### 8.2 å®¡æŸ¥è€…æ£€æŸ¥

- [ ] ä»£ç é€»è¾‘æ­£ç¡®
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æµ‹è¯•è¦†ç›–å……åˆ†
- [ ] æ€§èƒ½æ— æ˜æ˜¾é—®é¢˜
- [ ] ç¬¦åˆé¡¹ç›®æ¶æ„
- [ ] æ–‡æ¡£æ¸…æ™°å‡†ç¡®

---

## 9. æ€§èƒ½ä¼˜åŒ–æŒ‡å—

### 9.1 é¿å…ä¸å¿…è¦çš„å…‹éš†

```rust
// âŒ åï¼šä¸å¿…è¦çš„å…‹éš†
fn process(data: String) {
    let copy = data.clone();
    println!("{}", copy);
}

// âœ… å¥½ï¼šä½¿ç”¨å¼•ç”¨
fn process(data: &str) {
    println!("{}", data);
}
```

### 9.2 ä½¿ç”¨ Arc å…±äº«æ•°æ®

```rust
// âœ… å¥½ï¼šå¤šçº¿ç¨‹å…±äº«
let module = Arc::new(compiled_module);
let module_clone = module.clone(); // åªå…‹éš†æŒ‡é’ˆ
```

### 9.3 é¢„åˆ†é…å®¹é‡

```rust
// âœ… å¥½ï¼šé¢„åˆ†é…é¿å…é‡æ–°åˆ†é…
let mut vec = Vec::with_capacity(100);
```

---

## 10. å®‰å…¨ç¼–ç å®è·µ

### 10.1 é¿å… unsafe

```rust
// âŒ åï¼šä¸å¿…è¦çš„ unsafe
unsafe {
    let ptr = data.as_ptr();
    // ...
}

// âœ… å¥½ï¼šä½¿ç”¨å®‰å…¨ API
let slice = &data[..];
```

### 10.2 éªŒè¯è¾“å…¥

```rust
// âœ… å¥½ï¼šéªŒè¯å¤–éƒ¨è¾“å…¥
pub fn load_plugin(&self, plugin_id: &str, wasm_bytes: &[u8]) -> Result<()> {
    if plugin_id.is_empty() {
        return Err(FluxError::InvalidInput("plugin_id cannot be empty".into()));
    }
    if wasm_bytes.is_empty() {
        return Err(FluxError::InvalidInput("wasm_bytes cannot be empty".into()));
    }
    // ...
}
```

### 10.3 èµ„æºæ¸…ç†

```rust
// âœ… å¥½ï¼šç¡®ä¿èµ„æºé‡Šæ”¾
pub fn call_plugin(&self, plugin_id: &str, input: &str) -> Result<i32> {
    let mut instance = self.acquire_instance(plugin_id)?;
    let result = self.execute_plugin_call(&mut instance, input);
    self.release_instance(plugin_id, instance)?; // æ— è®ºæˆåŠŸå¤±è´¥éƒ½é‡Šæ”¾
    result
}
```

---

## 11. æ•…éšœæ’æŸ¥

### 11.1 ç¼–è¯‘é”™è¯¯

**é—®é¢˜**: `error[E0382]: use of moved value`

**è§£å†³**: ä½¿ç”¨å¼•ç”¨æˆ–å…‹éš†
```rust
// ä¿®å¤å‰
let data = String::from("test");
process(data);
println!("{}", data); // é”™è¯¯ï¼šdata å·²ç§»åŠ¨

// ä¿®å¤å
let data = String::from("test");
process(&data);
println!("{}", data); // OK
```

### 11.2 Clippy è­¦å‘Š

**é—®é¢˜**: `warning: this expression creates a reference which is immediately dereferenced`

**è§£å†³**: ç§»é™¤ä¸å¿…è¦çš„å¼•ç”¨
```rust
// ä¿®å¤å‰
let result = function(&data);

// ä¿®å¤å
let result = function(data);
```

---

## 12. å·¥å…·é“¾

### 12.1 å¿…éœ€å·¥å…·

```bash
# å®‰è£… Rust å·¥å…·é“¾
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# å®‰è£…ç»„ä»¶
rustup component add rustfmt clippy
```

### 12.2 æ¨èå·¥å…·

- **rust-analyzer**: IDE æ™ºèƒ½æç¤º
- **cargo-watch**: è‡ªåŠ¨é‡æ–°ç¼–è¯‘
- **cargo-audit**: å®‰å…¨å®¡è®¡
- **cargo-outdated**: ä¾èµ–æ›´æ–°æ£€æŸ¥

```bash
# å®‰è£…æ¨èå·¥å…·
cargo install cargo-watch cargo-audit cargo-outdated
```

---

## 13. æ€»ç»“

### ä»£ç è´¨é‡æ£€æŸ¥æ¸…å•

| æ£€æŸ¥é¡¹ | å·¥å…· | å‘½ä»¤ | çŠ¶æ€ |
|--------|------|------|------|
| æ ¼å¼åŒ– | rustfmt | `cargo fmt --check` | âœ… |
| é™æ€åˆ†æ | clippy | `cargo clippy -D warnings` | âœ… |
| å•å…ƒæµ‹è¯• | cargo test | `cargo test --workspace` | âœ… |
| ç¼–è¯‘æ£€æŸ¥ | cargo | `cargo build --workspace` | âœ… |
| é”™è¯¯ç±»å‹ | thiserror | æ‰‹åŠ¨æ£€æŸ¥ | âœ… |
| Git Hooks | è‡ªå®šä¹‰ | `./scripts/setup-hooks.sh` | âœ… |

### å…³é”®æŒ‡æ ‡

- **æµ‹è¯•è¦†ç›–ç‡**: 80%+
- **ç¼–è¯‘è­¦å‘Š**: 0
- **Clippy è­¦å‘Š**: 0
- **æœªå¤„ç† unwrap**: 0
- **ä»£ç é‡å¤ç‡**: < 5%

---

*æœ€åæ›´æ–°: 2026å¹´02æœˆ11æ—¥*
