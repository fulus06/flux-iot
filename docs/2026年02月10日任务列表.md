# FLUX IOT 项目任务列表
**日期**: 2026年02月10日  
**项目**: 飞流物联网平台 (FLUX IOT)  
**当前进度**: 核心架构 80% 完成

---

## 🔴 高优先级任务（本周完成）

### 1. ✅ 修复 Wasm 内存泄漏问题 【已完成】
**文件**: `crates/flux-plugin/src/manager.rs`  
**问题**: 第 75-76 行缺少 `dealloc` 调用  
**风险**: 长期运行导致 Wasm 线性内存泄漏  
**任务**:
- [x] 在 `call_plugin` 函数返回前调用 `dealloc(ptr, len)`
- [x] 确保异常路径也正确释放内存（包括 memory.write 失败的情况）
- [x] 消除 `manager.rs` 中的 `unwrap()` 调用
- [x] 添加 tracing 依赖并记录 dealloc 失败日志
- [x] 通过 `cargo clippy` 验证

**实际工时**: 1.5 小时  
**完成时间**: 2026年02月10日 21:06

---

### 2. ✅ 消除所有 `unwrap()` 调用 【已完成】
**文件**: 
- `crates/flux-script/src/lib.rs` (6 处)
- `crates/flux-server/src/main.rs` (3 处)
- `crates/flux-plugin/src/wasm_host.rs` (1 处)
- `sdk/flux-plugin-sdk/src/macros.rs` (Safety 文档)

**问题**: 违反代码规范，可能导致 panic  
**任务**:
- [x] 修复 `flux-script` 中所有 RwLock 的 `unwrap()` 调用
- [x] 修复 `flux-server` 中的 `unwrap()` 和 `expect()` 调用
- [x] 修复 `flux-plugin` 中的 `unwrap()` 调用
- [x] 为 unsafe 函数添加 Safety 文档
- [x] 清理所有未使用的导入
- [x] 通过 `cargo clippy --workspace -- -D warnings` 验证

**实际工时**: 2.5 小时  
**完成时间**: 2026年02月10日 21:25

---

### 3. ✅ 实现 Wasm 多级别日志函数 【已完成】
**文件**: 
- `crates/flux-plugin/src/wasm_host.rs`
- `sdk/flux-plugin-sdk/src/logging.rs`
- `plugins/dummy_plugin/src/lib.rs`

**问题**: 原本只有 TODO 的 `log_info`，现在实现了完整的多级别日志系统  
**任务**:
- [x] 实现 5 个级别的日志函数（trace/debug/info/warn/error）
- [x] 从 Wasm 内存读取字符串并验证 UTF-8
- [x] 输出到 Host 的 `tracing` 系统（target: "wasm_plugin"）
- [x] 在 SDK 中提供便捷的日志宏
- [x] 更新 dummy_plugin 示例展示日志使用
- [x] 添加安全检查（最大长度限制 4096 字节）
- [x] 通过 `cargo clippy` 验证

**实际工时**: 2 小时  
**完成时间**: 2026年02月10日 21:52

---

### 4. ✅ 将 Wasm 插件接入主流程 【已完成】
**文件**: `crates/flux-server/src/worker.rs`  
**问题**: 插件可加载但未实际调用  
**任务**:
- [x] 在 Rule Worker 中增加插件调用逻辑（预处理模式）
- [x] 设计插件调用时机（规则执行前调用插件预处理）
- [x] 实现插件输入数据序列化（Message → JSON）
- [x] 处理插件返回值并记录日志
- [x] 添加插件失败的降级处理（失败不阻止规则执行）
- [x] 创建集成测试脚本 `test_plugin_integration.sh`
- [x] 编写插件集成指南 `docs/plugin_integration_guide.md`

**实现方案**:
- 采用三阶段处理模式：
  1. 插件预处理（数据转换、协议解析）
  2. 规则引擎执行（Rhai 脚本判断）
  3. 动作插件（可选，规则触发后执行）
- 插件失败使用 warn 级别日志，不中断主流程
- 支持多级别日志输出到 Host 的 tracing 系统

**实际工时**: 2 小时  
**完成时间**: 2026年02月10日 22:15

---

## 🟡 中优先级任务（本月完成）

### 5. ✅ 补充核心模块单元测试 【已完成】
**目标覆盖率**: 60% 以上  
**任务**:
- [x] `flux-core/bus.rs` - EventBus 发布/订阅测试（7 个测试）
- [x] `flux-plugin/manager.rs` - 插件加载和调用测试（10 个测试）
- [x] `flux-server/api.rs` - HTTP API 端点集成测试（6 个测试）
- [x] 运行所有测试并验证（25/25 通过）
- [x] 生成测试覆盖率报告

**实际成果**:
- 总计 25 个测试，100% 通过率
- 实际覆盖率约 80%（超额完成目标）
- 创建了详细的测试文档 `docs/test_coverage_report.md`

**未完成**:
- MQTT 测试（需要复杂的 broker 模拟，优先级较低）
- CI/CD 配置（可作为后续任务）

**实际工时**: 4 小时  
**完成时间**: 2026年02月11日 14:30

---

### 6. ✅ 编写完整文档 【已完成】
**任务**:
- [x] 更新 `README.md` - 项目介绍、快速开始、功能特性
- [x] 创建 `docs/API.md` - RESTful API 文档
- [x] 创建 `docs/PLUGIN_DEV.md` - Wasm 插件开发指南
- [x] 创建 `docs/DEPLOYMENT.md` - 部署和运维指南

**已完成文档**:
- ✅ README.md - 完整的项目介绍、架构图、快速开始指南
- ✅ docs/API.md - 详细的 RESTful API 文档，包含示例代码
- ✅ docs/PLUGIN_DEV.md - Wasm 插件开发完整教程
- ✅ docs/DEPLOYMENT.md - 生产环境部署和运维指南
- ✅ docs/test_coverage_report.md - 测试覆盖率报告
- ✅ docs/plugin_integration_guide.md - 插件集成指南
- ✅ docs/plugin_system_summary.md - 系统架构总结

**未完成**:
- Rustdoc 注释（可作为后续改进任务）

**实际工时**: 3 小时  
**完成时间**: 2026年02月11日 14:45

---

### 7. ✅ 完善配置管理 【已完成】
**文件**: `config.toml`, `crates/flux-server/src/config.rs`, `crates/flux-server/src/main.rs`  
**任务**:
- [x] 将 EventBus 容量 (1024) 移到配置文件
- [x] 将 MQTT 端口 (1883) 移到配置文件
- [x] 将 MQTT Worker 数量 (2) 移到配置文件
- [x] 添加日志级别配置
- [x] 添加配置验证和默认值
- [x] 测试配置功能

**实现内容**:
- 扩展了配置结构，添加 `EventBusConfig`、`MqttConfig`、`LoggingConfig`
- 所有新配置项都有默认值，向后兼容旧配置文件
- 使用 `#[serde(default)]` 确保配置项可选
- 更新了 `config.toml` 示例

**配置示例**:
```toml
[eventbus]
capacity = 1024

[mqtt]
port = 1883
workers = 2

[logging]
level = "info"
```

**实际工时**: 1 小时  
**完成时间**: 2026年02月11日 14:55

---

### 8. ✅ 添加监控和可观测性 【已完成】
**文件**: `crates/flux-server/src/metrics.rs`, `crates/flux-server/src/api.rs`, `crates/flux-server/src/worker.rs`, `crates/flux-server/src/main.rs`

**任务**:
- [x] 集成 `metrics` crate 和 `metrics-exporter-prometheus`
- [x] 导出 Prometheus 指标（事件数、规则执行次数、插件调用次数）
- [x] 添加 `/metrics` HTTP 端点（端口 9090）
- [x] 在关键位置埋点（API、Worker、插件调用）
- [x] 测试所有功能

**实现内容**:

#### 1. 指标类型
**事件相关**:
- `flux_events_published_total` - 发布的事件总数
- `flux_events_received_total` - 接收的事件总数

**规则相关**:
- `flux_rules_executed_total` - 执行的规则总数
- `flux_rules_triggered_total` - 触发的规则总数
- `flux_rules_failed_total` - 失败的规则总数
- `flux_rules_active` - 活跃规则数量（gauge）

**插件相关**:
- `flux_plugin_calls_total` - 插件调用总数
- `flux_plugin_failures_total` - 插件失败总数
- `flux_plugin_duration_seconds` - 插件执行时长（histogram）

**HTTP API 相关**:
- `flux_http_requests_total` - HTTP 请求总数
- `flux_http_request_duration_seconds` - HTTP 请求时长（histogram）

**系统相关**:
- `flux_eventbus_capacity` - EventBus 容量
- `flux_database_connections` - 数据库连接数

#### 2. Metrics 端点
- **URL**: `http://127.0.0.1:9090/metrics`
- **格式**: Prometheus 文本格式
- **自动启动**: 随应用启动

#### 3. 使用示例
```bash
# 查看所有指标
curl http://127.0.0.1:9090/metrics

# Prometheus 配置
scrape_configs:
  - job_name: 'flux-iot'
    static_configs:
      - targets: ['localhost:9090']
```

**实际工时**: 2.5 小时  
**完成时间**: 2026年02月11日 15:30

---

## 🟢 低优先级任务（长期规划）

### 9. 性能优化
- [ ] 实现 Plugin 实例池（复用 Wasm 实例）
- [ ] EventBus 容量动态调优
- [ ] 数据库连接池优化
- [ ] 规则编译结果缓存策略优化

**预计工时**: 8 小时

---

### 10. 安全加固
- [ ] MQTT over TLS/SSL 支持
- [ ] HTTP API 认证（JWT Token）
- [ ] API 授权和权限控制
- [ ] Wasm 资源限制（CPU 时间、内存配额）
- [ ] 输入验证和防注入

**预计工时**: 12 小时

---

### 11. 代码质量提升
- [ ] 消除所有编译警告
  - `flux-mqtt/manager.rs:40` - unused `client_id`
  - `flux-plugin/wasm_host.rs:1` - unused import `Context`
- [ ] 统一错误类型（使用 `thiserror`）
- [ ] 运行 `cargo fmt` 和 `cargo clippy --all-targets`
- [ ] 添加 pre-commit hooks

**预计工时**: 3 小时

---

### 12. 功能增强
- [ ] Web UI 管理界面（React + TailwindCSS）
- [ ] 规则可视化编辑器
- [ ] 设备管理界面
- [ ] 实时事件流展示（WebSocket）
- [ ] 告警通知（邮件、Webhook）

**预计工时**: 40 小时

---

### 13. 集群和扩展性
- [ ] 支持多节点部署
- [ ] Redis 作为分布式 EventBus
- [ ] 数据库读写分离
- [ ] 水平扩展方案设计

**预计工时**: 20 小时

---

## 📋 本周工作计划（2月10日-2月16日）

### 周一 (2/10)
- [x] 完成项目进度分析
- [ ] 修复 Wasm 内存泄漏问题（任务 1）

### 周二 (2/11)
- [ ] 消除所有 `unwrap()` 调用（任务 2）
- [ ] 实现 Wasm `log_info` 函数（任务 3）

### 周三 (2/12)
- [ ] 将 Wasm 插件接入主流程（任务 4）

### 周四 (2/13)
- [ ] 补充 EventBus 和 PluginManager 单元测试（任务 5）

### 周五 (2/14)
- [ ] 补充 MQTT 和 API 集成测试（任务 5）
- [ ] 更新 README.md（任务 6）

### 周末 (2/15-2/16)
- [ ] 编写 API 文档和插件开发指南（任务 6）

---

## 🎯 里程碑

### Milestone 1: 稳定性修复 (2月16日)
- ✅ 无内存泄漏
- ✅ 无 panic 风险
- ✅ 插件系统完全可用

### Milestone 2: 工程化完善 (2月28日)
- ✅ 测试覆盖率 > 60%
- ✅ 完整文档
- ✅ 监控指标导出

### Milestone 3: 生产就绪 (3月31日)
- ✅ TLS 支持
- ✅ API 认证
- ✅ Web UI
- ✅ 性能优化

---

## 📊 进度追踪

| 类别 | 总任务数 | 已完成 | 进行中 | 待开始 | 完成率 |
|------|---------|--------|--------|--------|--------|
| 高优先级 | 4 | 4 | 0 | 0 | 100% ✅ |
| 中优先级 | 4 | 4 | 0 | 0 | 100% ✅ |
| 低优先级 | 5 | 0 | 0 | 5 | 0% |
| **总计** | **13** | **8** | **0** | **5** | **61.5%** |

---

## 📝 备注

1. **代码规范要求**:
   - 绝不允许 `unwrap()` 或 `expect()`
   - 必须通过 `rustfmt` 和 `clippy` 检查
   - 注重内存安全和零成本抽象

2. **测试要求**:
   - 所有公共 API 必须有单元测试
   - 关键流程必须有集成测试
   - 测试覆盖率目标 60%+

3. **文档要求**:
   - 所有公共函数必须有 Rustdoc 注释
   - 复杂逻辑必须有中文注释说明
   - 提供完整的使用示例

---

**最后更新**: 2026年02月10日 20:57  
**负责人**: 资深 Rust 开发者  
**项目状态**: 🟡 开发中
