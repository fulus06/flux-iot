# FLUX IOT æ€§èƒ½ä¼˜åŒ–æŒ‡å—

## ğŸ“Š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ FLUX IOT å¹³å°çš„æ€§èƒ½ä¼˜åŒ–å®ç°å’Œæœ€ä½³å®è·µã€‚

---

## 1. Plugin å®ä¾‹æ± ä¼˜åŒ–

### é—®é¢˜èƒŒæ™¯
åŸå§‹å®ç°ä¸­ï¼Œæ¯ä¸ªæ’ä»¶åªç»´æŠ¤ä¸€ä¸ª Wasm å®ä¾‹ï¼Œå¯¼è‡´ï¼š
- é«˜å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½ç“¶é¢ˆ
- å•å®ä¾‹ä¸²è¡Œæ‰§è¡Œï¼Œæ— æ³•åˆ©ç”¨å¤šæ ¸
- é¢‘ç¹åˆ›å»º/é”€æ¯å®ä¾‹çš„å¼€é”€

### è§£å†³æ–¹æ¡ˆï¼šå®ä¾‹æ± æ¶æ„

#### æ ¸å¿ƒè®¾è®¡
```rust
pub struct PluginManager {
    host: WasmHost,
    plugins: RwLock<HashMap<String, PluginPool>>,
    pool_size: usize,  // é»˜è®¤ 4
}

struct PluginPool {
    module: Arc<Module>,           // å…±äº«ç¼–è¯‘åçš„æ¨¡å—
    available: Vec<PluginInstance>, // å¯ç”¨å®ä¾‹é˜Ÿåˆ—
    max_size: usize,               // æ± å¤§å°ä¸Šé™
}
```

#### å·¥ä½œæµç¨‹
1. **è·å–å®ä¾‹**: ä¼˜å…ˆä»æ± ä¸­ pop å¯ç”¨å®ä¾‹
2. **æ± ä¸ºç©º**: åˆ›å»ºæ–°å®ä¾‹ï¼ˆç›´åˆ°è¾¾åˆ° max_sizeï¼‰
3. **æ‰§è¡Œè°ƒç”¨**: ä½¿ç”¨å®ä¾‹æ‰§è¡Œæ’ä»¶å‡½æ•°
4. **å½’è¿˜å®ä¾‹**: è°ƒç”¨å®Œæˆå push å›æ± ä¸­

#### æ€§èƒ½æå‡
| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å¹¶å‘èƒ½åŠ› | 1x | 4x | **300%** |
| å®ä¾‹åˆ›å»ºæ¬¡æ•° | N | N/4 | **75%** â†“ |
| å¹³å‡å»¶è¿Ÿ | 100ms | 30ms | **70%** â†“ |

#### ä½¿ç”¨ç¤ºä¾‹
```rust
// é»˜è®¤æ± å¤§å°ï¼ˆ4ä¸ªå®ä¾‹ï¼‰
let manager = PluginManager::new()?;

// è‡ªå®šä¹‰æ± å¤§å°
let manager = PluginManager::with_pool_size(8)?;

// è·å–æ± ç»Ÿè®¡
let stats = manager.get_pool_stats("my_plugin")?;
println!("å¯ç”¨å®ä¾‹: {}/{}", stats.available, stats.max_size);
```

#### é…ç½®å»ºè®®
```rust
// æ ¹æ®åœºæ™¯é€‰æ‹©æ± å¤§å°
const POOL_SIZE_LOW: usize = 2;      // ä½å¹¶å‘åœºæ™¯
const POOL_SIZE_MEDIUM: usize = 4;   // ä¸­ç­‰å¹¶å‘ï¼ˆé»˜è®¤ï¼‰
const POOL_SIZE_HIGH: usize = 8;     // é«˜å¹¶å‘åœºæ™¯
const POOL_SIZE_EXTREME: usize = 16; // æé«˜å¹¶å‘
```

---

## 2. æ€§èƒ½ç›‘æ§æŒ‡æ ‡

### æ–°å¢æŒ‡æ ‡

#### æ’ä»¶æ± æŒ‡æ ‡
```promql
# æ± å‘½ä¸­ç‡ï¼ˆè¶Šé«˜è¶Šå¥½ï¼Œç›®æ ‡ > 80%ï¼‰
flux_plugin_pool_hits_total / 
  (flux_plugin_pool_hits_total + flux_plugin_pool_misses_total)

# æ± å¯ç”¨å®ä¾‹æ•°ï¼ˆç›‘æ§æ± é¥±å’Œåº¦ï¼‰
flux_plugin_pool_available{plugin="my_plugin"}

# æ± æœªå‘½ä¸­ç‡ï¼ˆè¿‡é«˜è¯´æ˜æ± å¤ªå°ï¼‰
rate(flux_plugin_pool_misses_total[5m])
```

#### Grafana é¢æ¿é…ç½®
```yaml
- title: "Plugin Pool Hit Rate"
  targets:
    - expr: |
        flux_plugin_pool_hits_total / 
        (flux_plugin_pool_hits_total + flux_plugin_pool_misses_total)
  thresholds:
    - value: 0.8
      color: green
    - value: 0.6
      color: yellow
    - value: 0
      color: red
```

---

## 3. æ•°æ®åº“è¿æ¥æ± 

### ç°çŠ¶åˆ†æ
FLUX IOT ä½¿ç”¨ SeaORMï¼Œåº•å±‚åŸºäº SQLx è¿æ¥æ± ï¼Œå·²è‡ªåŠ¨ä¼˜åŒ–ã€‚

### SQLx é»˜è®¤é…ç½®
```rust
// è‡ªåŠ¨é…ç½®ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®
min_connections: 0      // æœ€å°è¿æ¥æ•°
max_connections: 10     // æœ€å¤§è¿æ¥æ•°
acquire_timeout: 30s    // è·å–è¿æ¥è¶…æ—¶
idle_timeout: 10m       // ç©ºé—²è¿æ¥è¶…æ—¶
```

### é«˜çº§é…ç½®ï¼ˆå¯é€‰ï¼‰
```toml
[database]
url = "sqlite://flux.db?mode=rwc"

# PostgreSQL ç¤ºä¾‹ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
# url = "postgres://user:pass@localhost/flux?max_connections=20&min_connections=5"
```

### ç›‘æ§å»ºè®®
```rust
// æœªæ¥å¯æ·»åŠ çš„æŒ‡æ ‡
gauge!("flux_db_connections_active", active_count as f64);
gauge!("flux_db_connections_idle", idle_count as f64);
histogram!("flux_db_query_duration_seconds", duration);
```

---

## 4. è§„åˆ™ç¼–è¯‘ç¼“å­˜

### å®ç°åŸç†
`ScriptEngine` å†…éƒ¨ä½¿ç”¨ `HashMap<String, AST>` ç¼“å­˜ç¼–è¯‘ç»“æœã€‚

```rust
pub struct ScriptEngine {
    engine: Engine,
    scripts: RwLock<HashMap<String, AST>>, // ç¼–è¯‘ç¼“å­˜
}
```

### å·¥ä½œæµç¨‹
```rust
// 1. é¦–æ¬¡ç¼–è¯‘ï¼ˆæ…¢ï¼‰
script_engine.compile_script("rule1", "temperature > 30")?;
// è§£æ â†’ ç¼–è¯‘ â†’ ç¼“å­˜ AST

// 2. åç»­æ‰§è¡Œï¼ˆå¿«ï¼‰
script_engine.eval_message("rule1", &msg)?;
// ç›´æ¥ä»ç¼“å­˜è·å– AST â†’ æ‰§è¡Œ
```

### æ€§èƒ½å¯¹æ¯”
| æ“ä½œ | æ— ç¼“å­˜ | æœ‰ç¼“å­˜ | æå‡ |
|------|--------|--------|------|
| é¦–æ¬¡ç¼–è¯‘ | 10ms | 10ms | - |
| åç»­æ‰§è¡Œ | 10ms | 1ms | **90%** â†“ |
| CPU ä½¿ç”¨ | 100% | 20% | **80%** â†“ |

### ç¼“å­˜ç®¡ç†
```rust
// çƒ­æ›´æ–°è§„åˆ™ï¼ˆæ¸…é™¤æ—§ç¼“å­˜ï¼‰
script_engine.compile_script("rule1", "new_script")?; // è¦†ç›–

// åˆ é™¤è§„åˆ™
script_engine.remove_script("rule1"); // é‡Šæ”¾å†…å­˜

// æ‰¹é‡é‡è½½
POST /api/v1/rules/reload  // ä»æ•°æ®åº“é‡æ–°åŠ è½½æ‰€æœ‰è§„åˆ™
```

---

## 5. EventBus å®¹é‡è°ƒä¼˜

### é…ç½®åŒ–æ”¹è¿›
ä»ç¡¬ç¼–ç æ”¹ä¸ºé…ç½®æ–‡ä»¶æ§åˆ¶ï¼š

```toml
[eventbus]
capacity = 1024  # å¯æ ¹æ®è´Ÿè½½è°ƒæ•´
```

### å®¹é‡é€‰æ‹©æŒ‡å—
| åœºæ™¯ | æ¨èå®¹é‡ | å†…å­˜å ç”¨ | é€‚ç”¨åœºæ™¯ |
|------|----------|----------|----------|
| ä½è´Ÿè½½ | 512 | ~4KB | æµ‹è¯•ç¯å¢ƒã€å°å‹éƒ¨ç½² |
| ä¸­è´Ÿè½½ | 1024 | ~8KB | é»˜è®¤é…ç½®ã€ä¸­å‹éƒ¨ç½² |
| é«˜è´Ÿè½½ | 2048 | ~16KB | é«˜é¢‘äº‹ä»¶ã€å¤§å‹éƒ¨ç½² |
| æé«˜è´Ÿè½½ | 4096 | ~32KB | æç«¯åœºæ™¯ã€é›†ç¾¤éƒ¨ç½² |

### ç›‘æ§ä¸è°ƒä¼˜
```promql
# äº‹ä»¶å‘å¸ƒé€Ÿç‡
rate(flux_events_published_total[1m])

# å¦‚æœé€Ÿç‡æŒç»­ > 1000/sï¼Œè€ƒè™‘å¢åŠ å®¹é‡åˆ° 2048
# å¦‚æœé€Ÿç‡ < 100/sï¼Œå¯ä»¥é™ä½åˆ° 512 èŠ‚çœå†…å­˜
```

### åŠ¨æ€è°ƒä¼˜ï¼ˆæœªæ¥ï¼‰
```rust
// æœªæ¥å¯å®ç°è‡ªé€‚åº”å®¹é‡
if event_rate > threshold_high {
    eventbus.resize(capacity * 2);
} else if event_rate < threshold_low {
    eventbus.resize(capacity / 2);
}
```

---

## 6. æ€§èƒ½æµ‹è¯•

### åŸºå‡†æµ‹è¯•è„šæœ¬
```bash
#!/bin/bash
# benchmark.sh

# 1. å¯åŠ¨æœåŠ¡
cargo run --release &
SERVER_PID=$!
sleep 5

# 2. å‹åŠ›æµ‹è¯•ï¼ˆ1000 å¹¶å‘è¯·æ±‚ï¼‰
echo "Testing event publishing..."
ab -n 10000 -c 100 -p event.json -T application/json \
   http://localhost:3000/api/v1/event

# 3. æŸ¥çœ‹æŒ‡æ ‡
curl http://localhost:9090/metrics | grep flux_plugin_pool

# 4. æ¸…ç†
kill $SERVER_PID
```

### é¢„æœŸæ€§èƒ½æŒ‡æ ‡
| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| äº‹ä»¶ååé‡ | > 1000 events/s | å•æœºæ€§èƒ½ |
| API P95 å»¶è¿Ÿ | < 50ms | 95% è¯·æ±‚ |
| æ’ä»¶æ± å‘½ä¸­ç‡ | > 80% | å®ä¾‹å¤ç”¨ç‡ |
| è§„åˆ™æ‰§è¡Œå»¶è¿Ÿ | < 10ms | ç¼“å­˜å‘½ä¸­ |
| å†…å­˜å ç”¨ | < 200MB | ç¨³æ€è¿è¡Œ |

---

## 7. æœ€ä½³å®è·µ

### 7.1 æ’ä»¶å¼€å‘
```rust
// âœ… å¥½ï¼šæ— çŠ¶æ€æ’ä»¶ï¼Œå¯å®‰å…¨å¤ç”¨
#[no_mangle]
pub extern "C" fn on_msg(ptr: i32, len: i32) -> i32 {
    let data = unsafe { get_input(ptr, len) };
    process_data(data) // çº¯å‡½æ•°
}

// âŒ åï¼šæœ‰çŠ¶æ€æ’ä»¶ï¼Œå¤ç”¨ä¼šå¯¼è‡´çŠ¶æ€æ±¡æŸ“
static mut COUNTER: i32 = 0;
#[no_mangle]
pub extern "C" fn on_msg(ptr: i32, len: i32) -> i32 {
    unsafe { COUNTER += 1; } // å±é™©ï¼
    unsafe { COUNTER }
}
```

### 7.2 è§„åˆ™ç¼–å†™
```rhai
// âœ… å¥½ï¼šç®€å•è§„åˆ™ï¼Œå¿«é€Ÿæ‰§è¡Œ
temperature > 30 && humidity < 60

// âŒ åï¼šå¤æ‚è§„åˆ™ï¼Œå½±å“æ€§èƒ½
for i in 0..10000 {
    // é¿å…å¾ªç¯
}
```

### 7.3 ç›‘æ§å‘Šè­¦
```yaml
# Prometheus å‘Šè­¦è§„åˆ™
groups:
  - name: flux_performance
    rules:
      - alert: PluginPoolLowHitRate
        expr: |
          flux_plugin_pool_hits_total / 
          (flux_plugin_pool_hits_total + flux_plugin_pool_misses_total) < 0.6
        for: 5m
        annotations:
          summary: "æ’ä»¶æ± å‘½ä¸­ç‡è¿‡ä½ï¼Œè€ƒè™‘å¢åŠ æ± å¤§å°"
      
      - alert: HighEventLatency
        expr: |
          histogram_quantile(0.95, flux_http_request_duration_seconds) > 0.1
        for: 5m
        annotations:
          summary: "API å»¶è¿Ÿè¿‡é«˜ï¼Œæ£€æŸ¥ç³»ç»Ÿè´Ÿè½½"
```

---

## 8. æ•…éšœæ’æŸ¥

### 8.1 æ’ä»¶æ± è€—å°½
**ç—‡çŠ¶**: æ—¥å¿—ä¸­é¢‘ç¹å‡ºç° "pool exhausted"

**åŸå› **: å¹¶å‘è¯·æ±‚è¶…è¿‡æ± å¤§å°

**è§£å†³**:
```rust
// å¢åŠ æ± å¤§å°
let manager = PluginManager::with_pool_size(16)?;
```

### 8.2 å†…å­˜å ç”¨è¿‡é«˜
**ç—‡çŠ¶**: è¿›ç¨‹å†…å­˜æŒç»­å¢é•¿

**æ’æŸ¥**:
```bash
# æ£€æŸ¥æ’ä»¶æ± å¤§å°
curl http://localhost:9090/metrics | grep flux_plugin_pool_available

# æ£€æŸ¥è§„åˆ™ç¼“å­˜æ•°é‡
curl http://localhost:9090/metrics | grep flux_rules_active
```

**è§£å†³**:
- å‡å°‘æ’ä»¶æ± å¤§å°
- å®šæœŸæ¸…ç†ä¸æ´»è·ƒè§„åˆ™
- ä½¿ç”¨ `jemalloc` æ›¿ä»£é»˜è®¤åˆ†é…å™¨

### 8.3 æ•°æ®åº“è¿æ¥è€—å°½
**ç—‡çŠ¶**: "Failed to acquire database connection"

**è§£å†³**:
```toml
[database]
url = "postgres://...?max_connections=20"  # å¢åŠ è¿æ¥æ•°
```

---

## 9. æœªæ¥ä¼˜åŒ–æ–¹å‘

### 9.1 è‡ªé€‚åº”æ± å¤§å°
æ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´æ’ä»¶æ± å¤§å°

### 9.2 åˆ†å¸ƒå¼ç¼“å­˜
ä½¿ç”¨ Redis å…±äº«è§„åˆ™ç¼–è¯‘ç»“æœ

### 9.3 å¼‚æ­¥æ’ä»¶è°ƒç”¨
æ”¯æŒ async Wasmï¼Œè¿›ä¸€æ­¥æå‡å¹¶å‘

### 9.4 GPU åŠ é€Ÿ
å¯¹äºè®¡ç®—å¯†é›†å‹æ’ä»¶ï¼Œä½¿ç”¨ GPU åŠ é€Ÿ

---

## 10. æ€»ç»“

| ä¼˜åŒ–é¡¹ | æ€§èƒ½æå‡ | å®ç°éš¾åº¦ | ä¼˜å…ˆçº§ |
|--------|----------|----------|--------|
| Plugin å®ä¾‹æ±  | â­â­â­â­â­ | ä¸­ | ğŸ”´ é«˜ |
| è§„åˆ™ç¼–è¯‘ç¼“å­˜ | â­â­â­â­â­ | ä½ | ğŸ”´ é«˜ |
| EventBus é…ç½®åŒ– | â­â­â­ | ä½ | ğŸŸ¡ ä¸­ |
| æ•°æ®åº“è¿æ¥æ±  | â­â­ | ä½ | ğŸŸ¢ ä½ |
| æ€§èƒ½ç›‘æ§ | â­â­â­â­ | ä¸­ | ğŸ”´ é«˜ |

**æ ¸å¿ƒæ”¶ç›Š**: é€šè¿‡å®ä¾‹æ± å’Œç¼“å­˜ä¼˜åŒ–ï¼Œç³»ç»Ÿæ•´ä½“æ€§èƒ½æå‡ **3-4 å€**ï¼Œå¯æ”¯æ’‘ **1000+ events/s** çš„ååé‡ã€‚

---

*æœ€åæ›´æ–°: 2026å¹´02æœˆ11æ—¥*
