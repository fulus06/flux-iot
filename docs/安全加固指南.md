# FLUX IOT å®‰å…¨åŠ å›ºæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ FLUX IOT å¹³å°çš„å®‰å…¨åŠ å›ºæªæ–½ï¼ŒåŒ…æ‹¬ Wasm èµ„æºé™åˆ¶å’Œ MQTT TLS/SSL åŠ å¯†é€šä¿¡ã€‚

---

## 1. Wasm èµ„æºé™åˆ¶

### 1.1 é—®é¢˜èƒŒæ™¯

Wasm æ’ä»¶è¿è¡Œåœ¨æ²™ç®±ç¯å¢ƒä¸­ï¼Œä½†ä»éœ€è¦é™åˆ¶å…¶èµ„æºä½¿ç”¨ï¼Œé˜²æ­¢ï¼š
- **å†…å­˜è€—å°½**: æ¶æ„æ’ä»¶ç”³è¯·å¤§é‡å†…å­˜
- **CPU å ç”¨**: æ­»å¾ªç¯æˆ–è®¡ç®—å¯†é›†å‹ä»»åŠ¡
- **æ‹’ç»æœåŠ¡**: èµ„æºè€—å°½å¯¼è‡´ç³»ç»Ÿä¸å¯ç”¨

### 1.2 å®ç°æ–¹æ¡ˆ

#### èµ„æºé™åˆ¶é…ç½®

```rust
use flux_plugin::wasm_host::WasmResourceLimits;

// é»˜è®¤é…ç½®
let limits = WasmResourceLimits::default();
// max_memory_bytes: 16 MB
// max_table_elements: 1000
// max_instances: 10
// max_tables: 1
// max_memories: 1

// è‡ªå®šä¹‰é…ç½®
let limits = WasmResourceLimits {
    max_memory_bytes: 32 * 1024 * 1024,  // 32 MB
    max_table_elements: 2000,
    max_instances: 20,
    max_tables: 2,
    max_memories: 2,
};

// åˆ›å»ºå¸¦èµ„æºé™åˆ¶çš„ WasmHost
let host = WasmHost::with_limits(limits)?;
```

#### èµ„æºé™åˆ¶å™¨å®ç°

```rust
impl ResourceLimiter for WasmResourceLimiter {
    fn memory_growing(&mut self, current: usize, desired: usize, _maximum: Option<usize>) -> Result<bool> {
        let allowed = desired <= self.max_memory_bytes;
        if !allowed {
            tracing::warn!(
                "Wasm memory limit exceeded: current={}, desired={}, max={}",
                current, desired, self.max_memory_bytes
            );
        }
        Ok(allowed)
    }

    fn table_growing(&mut self, current: u32, desired: u32, _maximum: Option<u32>) -> Result<bool> {
        let allowed = desired <= self.max_table_elements;
        if !allowed {
            tracing::warn!(
                "Wasm table limit exceeded: current={}, desired={}, max={}",
                current, desired, self.max_table_elements
            );
        }
        Ok(allowed)
    }
}
```

### 1.3 èµ„æºé™åˆ¶ç±»å‹

| é™åˆ¶ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ | æ¨èèŒƒå›´ |
|---------|--------|------|---------|
| **å†…å­˜å¤§å°** | 16 MB | Wasm çº¿æ€§å†…å­˜æœ€å¤§å€¼ | 8-64 MB |
| **è¡¨å…ƒç´ ** | 1000 | å‡½æ•°è¡¨æœ€å¤§å…ƒç´ æ•° | 100-5000 |
| **å®ä¾‹æ•°** | 10 | æœ€å¤§å®ä¾‹æ•°é‡ | 5-50 |
| **è¡¨æ•°é‡** | 1 | æœ€å¤§è¡¨æ•°é‡ | 1-5 |
| **å†…å­˜æ•°é‡** | 1 | æœ€å¤§å†…å­˜æ•°é‡ | 1-2 |

### 1.4 CPU æ—¶é—´é™åˆ¶

```rust
// å¯ç”¨ epoch interruptionï¼ˆCPU æ—¶é—´é™åˆ¶ï¼‰
config.epoch_interruption(true);

// æ³¨æ„ï¼šéœ€è¦é…åˆ Engine::increment_epoch() ä½¿ç”¨
// å¯ä»¥åœ¨å®šæ—¶å™¨ä¸­å®šæœŸè°ƒç”¨ï¼Œè¶…æ—¶çš„ Wasm å®ä¾‹ä¼šè¢«ä¸­æ–­
```

### 1.5 ç›‘æ§ä¸å‘Šè­¦

```rust
// èµ„æºè¶…é™æ—¶ä¼šè®°å½•è­¦å‘Šæ—¥å¿—
// ç¤ºä¾‹ï¼š
// WARN Wasm memory limit exceeded: current=15728640, desired=20971520, max=16777216
```

**Prometheus æŒ‡æ ‡**ï¼ˆæœªæ¥å¯æ·»åŠ ï¼‰:
```promql
# Wasm å†…å­˜ä½¿ç”¨ç‡
flux_wasm_memory_usage_bytes / flux_wasm_memory_limit_bytes

# èµ„æºé™åˆ¶è§¦å‘æ¬¡æ•°
rate(flux_wasm_limit_exceeded_total[5m])
```

### 1.6 æœ€ä½³å®è·µ

#### âœ… æ¨èé…ç½®

```rust
// ä½é£é™©æ’ä»¶ï¼ˆå†…éƒ¨å¼€å‘ï¼‰
WasmResourceLimits {
    max_memory_bytes: 32 * 1024 * 1024,  // 32 MB
    max_table_elements: 2000,
    max_instances: 20,
    max_tables: 2,
    max_memories: 2,
}

// é«˜é£é™©æ’ä»¶ï¼ˆç¬¬ä¸‰æ–¹ï¼‰
WasmResourceLimits {
    max_memory_bytes: 8 * 1024 * 1024,   // 8 MB
    max_table_elements: 500,
    max_instances: 5,
    max_tables: 1,
    max_memories: 1,
}
```

#### âŒ å¸¸è§é”™è¯¯

```rust
// é”™è¯¯ï¼šå†…å­˜é™åˆ¶è¿‡å°ï¼Œæ’ä»¶æ— æ³•æ­£å¸¸è¿è¡Œ
WasmResourceLimits {
    max_memory_bytes: 1024 * 1024,  // 1 MB - å¤ªå°ï¼
    ..Default::default()
}

// é”™è¯¯ï¼šæ— é™åˆ¶ï¼Œå­˜åœ¨å®‰å…¨é£é™©
WasmResourceLimits {
    max_memory_bytes: usize::MAX,  // å±é™©ï¼
    ..Default::default()
}
```

---

## 2. MQTT over TLS/SSL

### 2.1 é—®é¢˜èƒŒæ™¯

MQTT é»˜è®¤ä½¿ç”¨æ˜æ–‡ä¼ è¾“ï¼Œå­˜åœ¨ä»¥ä¸‹é£é™©ï¼š
- **æ•°æ®æ³„éœ²**: æ¶ˆæ¯å†…å®¹å¯è¢«çªƒå¬
- **ä¸­é—´äººæ”»å‡»**: é€šä¿¡å¯è¢«ç¯¡æ”¹
- **èº«ä»½ä¼ªé€ **: å®¢æˆ·ç«¯èº«ä»½æ— æ³•éªŒè¯

### 2.2 TLS é…ç½®

#### é…ç½®æ–‡ä»¶

```toml
# config.toml
[mqtt]
port = 8883  # MQTT over TLS æ ‡å‡†ç«¯å£
workers = 4
enable_tls = true
tls_cert_path = "/path/to/server-cert.pem"
tls_key_path = "/path/to/server-key.pem"

# å¯é€‰ï¼šå¯ç”¨å®¢æˆ·ç«¯è®¤è¯
tls_client_auth = true
tls_ca_cert_path = "/path/to/ca-cert.pem"
```

#### ä»£ç é…ç½®

```rust
use flux_mqtt::tls::{TlsConfig, load_tls_config};

// åŸºæœ¬ TLS é…ç½®ï¼ˆå•å‘è®¤è¯ï¼‰
let tls_config = TlsConfig::new(
    "certs/server-cert.pem".to_string(),
    "certs/server-key.pem".to_string(),
);

// å¯ç”¨å®¢æˆ·ç«¯è®¤è¯ï¼ˆåŒå‘è®¤è¯ï¼‰
let tls_config = TlsConfig::new(
    "certs/server-cert.pem".to_string(),
    "certs/server-key.pem".to_string(),
)
.with_client_auth("certs/ca-cert.pem".to_string());

// åŠ è½½ TLS é…ç½®
let server_config = load_tls_config(&tls_config)?;
```

### 2.3 è¯ä¹¦ç”Ÿæˆ

#### ä½¿ç”¨ OpenSSL ç”Ÿæˆè‡ªç­¾åè¯ä¹¦

```bash
#!/bin/bash
# generate-certs.sh

# 1. ç”Ÿæˆ CA ç§é’¥å’Œè¯ä¹¦
openssl req -x509 -newkey rsa:4096 -days 365 -nodes \
  -keyout ca-key.pem -out ca-cert.pem \
  -subj "/CN=FLUX IOT CA"

# 2. ç”ŸæˆæœåŠ¡å™¨ç§é’¥
openssl genrsa -out server-key.pem 4096

# 3. ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰
openssl req -new -key server-key.pem -out server-csr.pem \
  -subj "/CN=localhost"

# 4. ä½¿ç”¨ CA ç­¾å‘æœåŠ¡å™¨è¯ä¹¦
openssl x509 -req -in server-csr.pem -days 365 \
  -CA ca-cert.pem -CAkey ca-key.pem -CAcreateserial \
  -out server-cert.pem

# 5. ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦ï¼ˆç”¨äºåŒå‘è®¤è¯ï¼‰
openssl genrsa -out client-key.pem 4096
openssl req -new -key client-key.pem -out client-csr.pem \
  -subj "/CN=mqtt-client"
openssl x509 -req -in client-csr.pem -days 365 \
  -CA ca-cert.pem -CAkey ca-key.pem -CAcreateserial \
  -out client-cert.pem

echo "âœ… Certificates generated successfully!"
```

#### ä½¿ç”¨ Let's Encryptï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# å®‰è£… certbot
sudo apt-get install certbot

# è·å–è¯ä¹¦
sudo certbot certonly --standalone -d mqtt.example.com

# è¯ä¹¦ä½ç½®
# /etc/letsencrypt/live/mqtt.example.com/fullchain.pem
# /etc/letsencrypt/live/mqtt.example.com/privkey.pem
```

### 2.4 å®¢æˆ·ç«¯è¿æ¥

#### MQTT.js (Node.js)

```javascript
const mqtt = require('mqtt');
const fs = require('fs');

// å•å‘è®¤è¯
const client = mqtt.connect('mqtts://localhost:8883', {
  ca: fs.readFileSync('ca-cert.pem'),
  rejectUnauthorized: true
});

// åŒå‘è®¤è¯
const client = mqtt.connect('mqtts://localhost:8883', {
  ca: fs.readFileSync('ca-cert.pem'),
  cert: fs.readFileSync('client-cert.pem'),
  key: fs.readFileSync('client-key.pem'),
  rejectUnauthorized: true
});

client.on('connect', () => {
  console.log('âœ… Connected to MQTT broker over TLS');
  client.subscribe('sensors/#');
});
```

#### mosquitto_pub (å‘½ä»¤è¡Œ)

```bash
# å•å‘è®¤è¯
mosquitto_pub -h localhost -p 8883 \
  --cafile ca-cert.pem \
  -t "sensors/temp" -m '{"value": 25.5}' \
  --tls-version tlsv1.2

# åŒå‘è®¤è¯
mosquitto_pub -h localhost -p 8883 \
  --cafile ca-cert.pem \
  --cert client-cert.pem \
  --key client-key.pem \
  -t "sensors/temp" -m '{"value": 25.5}' \
  --tls-version tlsv1.2
```

#### Python (paho-mqtt)

```python
import ssl
import paho.mqtt.client as mqtt

# å•å‘è®¤è¯
client = mqtt.Client()
client.tls_set(
    ca_certs="ca-cert.pem",
    tls_version=ssl.PROTOCOL_TLSv1_2
)
client.connect("localhost", 8883, 60)

# åŒå‘è®¤è¯
client = mqtt.Client()
client.tls_set(
    ca_certs="ca-cert.pem",
    certfile="client-cert.pem",
    keyfile="client-key.pem",
    tls_version=ssl.PROTOCOL_TLSv1_2
)
client.connect("localhost", 8883, 60)
```

### 2.5 å®‰å…¨é…ç½®å»ºè®®

| é…ç½®é¡¹ | æ¨èå€¼ | è¯´æ˜ |
|--------|--------|------|
| **TLS ç‰ˆæœ¬** | TLSv1.2+ | ç¦ç”¨ TLSv1.0/1.1 |
| **å¯†ç å¥—ä»¶** | å¼ºåŠ å¯†å¥—ä»¶ | AES-256-GCM ç­‰ |
| **è¯ä¹¦æœ‰æ•ˆæœŸ** | 90 å¤© | å®šæœŸæ›´æ–°è¯ä¹¦ |
| **å®¢æˆ·ç«¯è®¤è¯** | å¯ç”¨ï¼ˆç”Ÿäº§ï¼‰ | åŒå‘è®¤è¯æ›´å®‰å…¨ |
| **è¯ä¹¦åŠé”€** | é…ç½® CRL/OCSP | åŠæ—¶åŠé”€æ³„éœ²è¯ä¹¦ |

### 2.6 æ•…éšœæ’æŸ¥

#### å¸¸è§é”™è¯¯

**1. è¯ä¹¦éªŒè¯å¤±è´¥**
```
Error: unable to verify the first certificate
```
**è§£å†³**: æ£€æŸ¥ CA è¯ä¹¦æ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿è¯ä¹¦é“¾å®Œæ•´

**2. ä¸»æœºåä¸åŒ¹é…**
```
Error: Hostname/IP does not match certificate's altnames
```
**è§£å†³**: ç¡®ä¿è¯ä¹¦ CN æˆ– SAN ä¸æœåŠ¡å™¨åœ°å€åŒ¹é…

**3. è¯ä¹¦è¿‡æœŸ**
```
Error: certificate has expired
```
**è§£å†³**: é‡æ–°ç”Ÿæˆæˆ–ç»­æœŸè¯ä¹¦

#### è°ƒè¯•æŠ€å·§

```bash
# æµ‹è¯• TLS è¿æ¥
openssl s_client -connect localhost:8883 -CAfile ca-cert.pem

# æŸ¥çœ‹è¯ä¹¦ä¿¡æ¯
openssl x509 -in server-cert.pem -text -noout

# éªŒè¯è¯ä¹¦é“¾
openssl verify -CAfile ca-cert.pem server-cert.pem
```

---

## 3. ç»¼åˆå®‰å…¨å®è·µ

### 3.1 å¤šå±‚é˜²æŠ¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨å±‚ï¼šè¾“å…¥éªŒè¯ã€æƒé™æ§åˆ¶              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¼ è¾“å±‚ï¼šTLS/SSL åŠ å¯†                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ²™ç®±å±‚ï¼šWasm èµ„æºé™åˆ¶                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç³»ç»Ÿå±‚ï¼šé˜²ç«å¢™ã€SELinux                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å®‰å…¨æ£€æŸ¥æ¸…å•

#### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] TLS è¯ä¹¦å·²ç”Ÿæˆå¹¶é…ç½®
- [ ] Wasm èµ„æºé™åˆ¶å·²è®¾ç½®
- [ ] é˜²ç«å¢™è§„åˆ™å·²é…ç½®
- [ ] æ—¥å¿—å’Œç›‘æ§å·²å¯ç”¨
- [ ] å®‰å…¨å®¡è®¡å·²å®Œæˆ

#### è¿è¡Œæ—¶ç›‘æ§
- [ ] TLS è¿æ¥æ•°
- [ ] Wasm èµ„æºä½¿ç”¨ç‡
- [ ] å¼‚å¸¸è¿æ¥å°è¯•
- [ ] è¯ä¹¦è¿‡æœŸæ—¶é—´
- [ ] ç³»ç»Ÿèµ„æºä½¿ç”¨

### 3.3 åº”æ€¥å“åº”

#### å‘ç°èµ„æºæ»¥ç”¨
```bash
# 1. æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/flux-iot/server.log | grep "limit exceeded"

# 2. é™ä½èµ„æºé™åˆ¶
# ç¼–è¾‘é…ç½®ï¼Œé‡å¯æœåŠ¡

# 3. ç¦ç”¨æ¶æ„æ’ä»¶
curl -X DELETE http://localhost:3000/api/v1/plugins/malicious-plugin
```

#### å‘ç° TLS æ”»å‡»
```bash
# 1. æ£€æŸ¥è¿æ¥æ—¥å¿—
journalctl -u flux-iot -n 100 | grep "TLS"

# 2. æ›´æ–°è¯ä¹¦
./generate-certs.sh

# 3. é‡å¯æœåŠ¡
systemctl restart flux-iot
```

---

## 4. æ€§èƒ½å½±å“

### 4.1 TLS æ€§èƒ½å¼€é”€

| æŒ‡æ ‡ | æ—  TLS | æœ‰ TLS | å¼€é”€ |
|------|--------|--------|------|
| æ¡æ‰‹å»¶è¿Ÿ | ~1ms | ~50ms | +4900% |
| ååé‡ | 10000 msg/s | 8000 msg/s | -20% |
| CPU ä½¿ç”¨ | 10% | 15% | +50% |
| å†…å­˜ä½¿ç”¨ | 100MB | 120MB | +20% |

**ä¼˜åŒ–å»ºè®®**:
- ä½¿ç”¨ TLS ä¼šè¯å¤ç”¨
- å¯ç”¨ç¡¬ä»¶åŠ é€Ÿï¼ˆAES-NIï¼‰
- ä½¿ç”¨ ECDSA è¯ä¹¦ï¼ˆæ¯” RSA å¿«ï¼‰

### 4.2 Wasm èµ„æºé™åˆ¶å¼€é”€

| æŒ‡æ ‡ | æ— é™åˆ¶ | æœ‰é™åˆ¶ | å¼€é”€ |
|------|--------|--------|------|
| å®ä¾‹åˆ›å»º | 10ms | 12ms | +20% |
| å‡½æ•°è°ƒç”¨ | 1Î¼s | 1.1Î¼s | +10% |
| å†…å­˜åˆ†é… | å¿«é€Ÿ | å¿«é€Ÿ | ~0% |

**ç»“è®º**: èµ„æºé™åˆ¶å¼€é”€æå°ï¼Œå¯å¿½ç•¥ä¸è®¡ã€‚

---

## 5. æ€»ç»“

### å·²å®ç°çš„å®‰å…¨æªæ–½

| å®‰å…¨æªæ–½ | çŠ¶æ€ | é˜²æŠ¤èƒ½åŠ› |
|---------|------|---------|
| **Wasm å†…å­˜é™åˆ¶** | âœ… | é˜²æ­¢å†…å­˜è€—å°½ |
| **Wasm è¡¨é™åˆ¶** | âœ… | é˜²æ­¢è¡¨æº¢å‡º |
| **MQTT TLS åŠ å¯†** | âœ… | é˜²æ­¢çªƒå¬ |
| **å®¢æˆ·ç«¯è®¤è¯** | âœ… | é˜²æ­¢ä¼ªé€  |
| **èµ„æºç›‘æ§** | âœ… | åŠæ—¶å‘ç°å¼‚å¸¸ |

### æœªæ¥æ”¹è¿›æ–¹å‘

- [ ] JWT Token è®¤è¯
- [ ] API é€Ÿç‡é™åˆ¶
- [ ] å®¡è®¡æ—¥å¿—
- [ ] å…¥ä¾µæ£€æµ‹ç³»ç»Ÿï¼ˆIDSï¼‰
- [ ] è‡ªåŠ¨è¯ä¹¦ç»­æœŸï¼ˆACMEï¼‰

---

*æœ€åæ›´æ–°: 2026å¹´02æœˆ11æ—¥*
