# å½•åƒç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

**è®¾è®¡æ—¶é—´**: 2026-02-19 17:50 UTC+08:00  
**çŠ¶æ€**: ğŸ“‹ **è®¾è®¡é˜¶æ®µ**

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

å®ç°ç‹¬ç«‹çš„å½•åƒç³»ç»Ÿï¼Œä¸æ—¶ç§»åŠŸèƒ½åˆ†å±‚ç®¡ç†ï¼Œæ»¡è¶³é•¿æœŸå­˜å‚¨éœ€æ±‚ã€‚

### æ ¸å¿ƒåŸåˆ™

1. **èŒè´£åˆ†ç¦»** - æ—¶ç§»å’Œå½•åƒæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿ
2. **åˆ†å±‚å­˜å‚¨** - æ—¶ç§»ç”¨ SSDï¼Œå½•åƒç”¨ HDD
3. **è‡ªåŠ¨å½’æ¡£** - æ—¶ç§»æ•°æ®è‡ªåŠ¨å½’æ¡£åˆ°å½•åƒ
4. **æŒ‰éœ€è®¿é—®** - å½•åƒæ”¯æŒé•¿æ—¶é—´èŒƒå›´æŸ¥è¯¢

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å®æ—¶æµè¾“å…¥                                  â”‚
â”‚         RTMP/RTSP/SRT/GB28181                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ—¶ç§»å±‚ï¼ˆå¿«é€Ÿï¼‰  â”‚            â”‚   å½•åƒå±‚ï¼ˆé•¿æœŸï¼‰  â”‚
â”‚                  â”‚            â”‚                  â”‚
â”‚  çƒ­ç¼“å­˜: 5-10åˆ†é’Ÿ â”‚            â”‚  24å°æ—¶å½•åƒ      â”‚
â”‚  å†·ç´¢å¼•: 1-2å°æ—¶  â”‚            â”‚  7-30å¤©å½’æ¡£      â”‚
â”‚  å­˜å‚¨: SSD       â”‚            â”‚  å­˜å‚¨: HDD       â”‚
â”‚  ç”¨é€”: å¿«é€Ÿå›çœ‹   â”‚            â”‚  ç”¨é€”: é•¿æœŸæŸ¥è¯¢   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                                 â†‘
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å½’æ¡£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    ï¼ˆ2å°æ—¶åï¼‰
```

---

## ğŸ“Š å¯¹æ¯”ï¼šæ—¶ç§» vs å½•åƒ

| ç‰¹æ€§ | æ—¶ç§»ç³»ç»Ÿ | å½•åƒç³»ç»Ÿ |
|------|---------|---------|
| **æ—¶é—´èŒƒå›´** | 5åˆ†é’Ÿ - 2å°æ—¶ | 24å°æ—¶ - 30å¤© |
| **å­˜å‚¨ä»‹è´¨** | SSDï¼ˆå¿«é€Ÿï¼‰ | HDDï¼ˆå¤§å®¹é‡ï¼‰ |
| **è®¿é—®é€Ÿåº¦** | < 50ms | < 500ms |
| **æ•°æ®æ ¼å¼** | åˆ†ç‰‡ï¼ˆSegmentï¼‰ | æ–‡ä»¶ï¼ˆMP4/TSï¼‰ |
| **æ¸…ç†ç­–ç•¥** | è‡ªåŠ¨æ¸…ç†ï¼ˆ2å°æ—¶ï¼‰ | æŒ‰ä¿ç•™å¤©æ•° |
| **ä½¿ç”¨åœºæ™¯** | ç›´æ’­å›çœ‹ã€é”™è¿‡ç¬é—´ | å†å²æŸ¥è¯¢ã€è¯æ®ä¿å­˜ |
| **å­˜å‚¨æˆæœ¬** | é«˜ï¼ˆSSDï¼‰ | ä½ï¼ˆHDDï¼‰ |

---

## ğŸ’» æ ¸å¿ƒç»„ä»¶è®¾è®¡

### æ–‡ä»¶åˆ†ç‰‡ç­–ç•¥ä¼˜åŒ–

**é—®é¢˜åˆ†æ**ï¼š
- 1å°æ—¶æ–‡ä»¶ â‰ˆ 900 MBï¼ˆ2 Mbps ç ç‡ï¼‰
- æ–‡ä»¶å¤ªå¤§å¯¼è‡´ï¼š
  - å†™å…¥å¤±è´¥é£é™©é«˜
  - æŸ¥æ‰¾å®šä½æ…¢
  - ä¸‹è½½æ—¶é—´é•¿
  - å†…å­˜å ç”¨å¤§

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```
æ¨èåˆ†ç‰‡å¤§å°ï¼š5-10 åˆ†é’Ÿ
- 5åˆ†é’Ÿ â‰ˆ 75 MBï¼ˆ2 Mbpsï¼‰
- 10åˆ†é’Ÿ â‰ˆ 150 MBï¼ˆ2 Mbpsï¼‰
- ä¾¿äºç®¡ç†å’Œä¼ è¾“
- å¿«é€Ÿå®šä½å’Œæ’­æ”¾
```

### 1. RecordingManagerï¼ˆå½•åƒç®¡ç†å™¨ï¼‰

```rust
pub struct RecordingManager {
    /// å½•åƒé…ç½®
    config: RecordingConfig,
    
    /// æ´»è·ƒçš„å½•åƒä¼šè¯
    sessions: Arc<RwLock<HashMap<String, RecordingSession>>>,
    
    /// å½•åƒæ–‡ä»¶ç´¢å¼•
    index: Arc<RwLock<RecordingIndex>>,
    
    /// å­˜å‚¨æ ¹ç›®å½•
    storage_root: PathBuf,
}

pub struct RecordingConfig {
    /// æ˜¯å¦å¯ç”¨å½•åƒ
    pub enabled: bool,
    
    /// ä¿ç•™å¤©æ•°
    pub retention_days: u64,
    
    /// å•ä¸ªæ–‡ä»¶æœ€å¤§æ—¶é•¿ï¼ˆç§’ï¼‰- ä¼˜åŒ–ä¸º 5-10 åˆ†é’Ÿ
    pub segment_duration: u64,  // é»˜è®¤ 300-600 ç§’
    
    /// å­˜å‚¨è·¯å¾„
    pub storage_path: PathBuf,
    
    /// å½’æ¡£å»¶è¿Ÿï¼ˆå°æ—¶ï¼‰
    pub archive_after_hours: u64,
    
    /// å‹ç¼©é€‰é¡¹
    pub compression: CompressionConfig,
}
```

### 2. RecordingSessionï¼ˆå½•åƒä¼šè¯ï¼‰

```rust
pub struct RecordingSession {
    /// æµ ID
    stream_id: String,
    
    /// å½“å‰å½•åƒæ–‡ä»¶
    current_file: RecordingFile,
    
    /// å¼€å§‹æ—¶é—´
    start_time: DateTime<Utc>,
    
    /// å·²å½•åˆ¶æ—¶é•¿
    duration: Duration,
    
    /// æ–‡ä»¶åˆ—è¡¨
    files: Vec<RecordingFile>,
}

pub struct RecordingFile {
    /// æ–‡ä»¶è·¯å¾„
    path: PathBuf,
    
    /// å¼€å§‹æ—¶é—´
    start_time: DateTime<Utc>,
    
    /// ç»“æŸæ—¶é—´
    end_time: Option<DateTime<Utc>>,
    
    /// æ–‡ä»¶å¤§å°
    size: u64,
    
    /// æ ¼å¼
    format: RecordingFormat,
}

pub enum RecordingFormat {
    Mp4,   // MP4 å®¹å™¨
    Ts,    // MPEG-TS
    Flv,   // FLV
}
```

### 3. RecordingIndexï¼ˆå½•åƒç´¢å¼•ï¼‰

```rust
pub struct RecordingIndex {
    /// æµ ID â†’ å½•åƒæ–‡ä»¶åˆ—è¡¨
    streams: HashMap<String, Vec<RecordingFileMetadata>>,
}

pub struct RecordingFileMetadata {
    pub file_path: PathBuf,
    pub stream_id: String,
    pub start_time: DateTime<Utc>,
    pub end_time: DateTime<Utc>,
    pub duration: f64,
    pub size: u64,
    pub format: RecordingFormat,
}
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. å½•åƒæµç¨‹

```
1. æµå¼€å§‹ â†’ åˆ›å»º RecordingSession
2. æ¥æ”¶æ•°æ® â†’ å†™å…¥å½“å‰å½•åƒæ–‡ä»¶
3. è¾¾åˆ°æ—¶é•¿é™åˆ¶ â†’ å…³é—­å½“å‰æ–‡ä»¶ï¼Œåˆ›å»ºæ–°æ–‡ä»¶
4. æµç»“æŸ â†’ å…³é—­ä¼šè¯ï¼Œæ›´æ–°ç´¢å¼•
```

### 2. å½’æ¡£æµç¨‹

```
1. å®šæ—¶ä»»åŠ¡æ£€æŸ¥æ—¶ç§»æ•°æ®
2. è¶…è¿‡ 2 å°æ—¶çš„æ•°æ® â†’ å½’æ¡£åˆ°å½•åƒå±‚
3. æ›´æ–°å½•åƒç´¢å¼•
4. ä»æ—¶ç§»å±‚åˆ é™¤
```

### 3. æ¸…ç†æµç¨‹

```
1. å®šæ—¶ä»»åŠ¡æ£€æŸ¥å½•åƒæ–‡ä»¶
2. è¶…è¿‡ä¿ç•™å¤©æ•° â†’ åˆ é™¤æ–‡ä»¶
3. æ›´æ–°ç´¢å¼•
```

---

## ğŸ“ æ–‡ä»¶ç»„ç»‡ç»“æ„

```
data/
â”œâ”€â”€ timeshift/              # æ—¶ç§»æ•°æ®ï¼ˆSSDï¼‰
â”‚   â”œâ”€â”€ rtmp/
â”‚   â”‚   â””â”€â”€ live_stream1/
â”‚   â”‚       â”œâ”€â”€ segment_1.ts
â”‚   â”‚       â””â”€â”€ segment_2.ts
â”‚   â”œâ”€â”€ rtsp/
â”‚   â””â”€â”€ srt/
â”‚
â””â”€â”€ recordings/             # å½•åƒæ•°æ®ï¼ˆHDDï¼‰
    â”œâ”€â”€ rtmp/
    â”‚   â””â”€â”€ live_stream1/
    â”‚       â”œâ”€â”€ 2026-02-19/
    â”‚       â”‚   â”œâ”€â”€ 00-00-00.mp4  # 00:00:00 å¼€å§‹
    â”‚       â”‚   â”œâ”€â”€ 01-00-00.mp4  # 01:00:00 å¼€å§‹
    â”‚       â”‚   â””â”€â”€ ...
    â”‚       â””â”€â”€ 2026-02-18/
    â”œâ”€â”€ rtsp/
    â””â”€â”€ srt/
```

---

## ğŸŒ HTTP API è®¾è®¡

### å½•åƒç®¡ç† API

```bash
# å¯åŠ¨å½•åƒ
POST /api/v1/recordings/start
{
  "stream_id": "rtmp/live/stream1",
  "format": "mp4"
}

# åœæ­¢å½•åƒ
POST /api/v1/recordings/stop
{
  "stream_id": "rtmp/live/stream1"
}

# æŸ¥è¯¢å½•åƒåˆ—è¡¨
GET /api/v1/recordings?stream_id=rtmp/live/stream1&start_date=2026-02-19&end_date=2026-02-20

# å“åº”
{
  "recordings": [
    {
      "file_id": "rec_123",
      "stream_id": "rtmp/live/stream1",
      "start_time": "2026-02-19T00:00:00Z",
      "end_time": "2026-02-19T01:00:00Z",
      "duration": 3600,
      "size": 900000000,
      "format": "mp4",
      "download_url": "/api/v1/recordings/rec_123/download"
    }
  ]
}

# ä¸‹è½½å½•åƒ
GET /api/v1/recordings/{file_id}/download

# æ’­æ”¾å½•åƒï¼ˆHLSï¼‰
GET /api/v1/recordings/{file_id}/playlist.m3u8
```

---

## ğŸ”§ é…ç½®è®¾è®¡

### å…¨å±€å½•åƒé…ç½®

```toml
# config/global.toml

[recording]
enabled = true
retention_days = 7              # ä¿ç•™ 7 å¤©
segment_duration = 3600         # 1 å°æ—¶ä¸€ä¸ªæ–‡ä»¶
storage_path = "./data/recordings"
archive_after_hours = 2         # 2 å°æ—¶åä»æ—¶ç§»å½’æ¡£
format = "mp4"                  # é»˜è®¤æ ¼å¼

# æ¸…ç†ç­–ç•¥
[recording.cleanup]
enabled = true
check_interval = 3600           # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
delete_empty_dirs = true        # åˆ é™¤ç©ºç›®å½•
```

### åè®®ç‰¹å®šé…ç½®

```toml
# config/protocols/rtmp.toml

[recording]
enabled = true
retention_days = 30             # RTMP ä¿ç•™ 30 å¤©ï¼ˆè¦†ç›–å…¨å±€ï¼‰
format = "mp4"

# config/protocols/rtsp.toml

[recording]
enabled = true
retention_days = 7              # RTSP ä¿ç•™ 7 å¤©ï¼ˆä½¿ç”¨å…¨å±€ï¼‰
format = "mp4"
```

---

## ğŸ’¾ å­˜å‚¨ç©ºé—´ä¼°ç®—

### ç¤ºä¾‹è®¡ç®—

```
å‡è®¾ï¼š
- 100 è·¯æµ
- æ¯è·¯ 2 Mbps
- ä¿ç•™ 7 å¤©

æ¯è·¯æ¯å¤© = 2 Mbps Ã— 24h / 8 = 21.6 GB
100 è·¯æ¯å¤© = 2.16 TB
7 å¤©æ€»è®¡ = 15.12 TB

æ¨èé…ç½®ï¼š
- 20 TB HDDï¼ˆè€ƒè™‘å†—ä½™ï¼‰
- RAID 5 æˆ– RAID 6
```

---

## ğŸ¯ ä¸æ—¶ç§»ç³»ç»Ÿçš„é›†æˆ

### æ•°æ®æµå‘

```
å®æ—¶æµ
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŒæ—¶å†™å…¥   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ—¶ç§»å±‚     â”‚ â† å¿«é€Ÿè®¿é—®ï¼ˆ2å°æ—¶å†…ï¼‰
â”‚  å½•åƒå±‚     â”‚ â† é•¿æœŸå­˜å‚¨ï¼ˆ7-30å¤©ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
2å°æ—¶åï¼Œæ—¶ç§»æ•°æ®è‡ªåŠ¨æ¸…ç†
å½•åƒæ•°æ®ç»§ç»­ä¿ç•™
```

### æŸ¥è¯¢ç­–ç•¥

```rust
pub async fn get_video_data(
    stream_id: &str,
    start_time: DateTime<Utc>,
) -> Result<VideoData> {
    let now = Utc::now();
    let offset = now - start_time;
    
    if offset <= Duration::hours(2) {
        // ä»æ—¶ç§»å±‚è·å–ï¼ˆå¿«é€Ÿï¼‰
        timeshift.get_segments_from(stream_id, start_time).await
    } else {
        // ä»å½•åƒå±‚è·å–ï¼ˆé•¿æœŸï¼‰
        recording.get_file_from(stream_id, start_time).await
    }
}
```

---

## ğŸŒŸ æ ¸å¿ƒä¼˜åŠ¿

### 1. èŒè´£æ¸…æ™°
- **æ—¶ç§»**ï¼šçŸ­æœŸã€å¿«é€Ÿã€ä¸´æ—¶
- **å½•åƒ**ï¼šé•¿æœŸã€å½’æ¡£ã€æ°¸ä¹…

### 2. æ€§èƒ½ä¼˜åŒ–
- æ—¶ç§»ç”¨ SSDï¼šå¿«é€Ÿå“åº”
- å½•åƒç”¨ HDDï¼šæˆæœ¬ä½

### 3. å­˜å‚¨é«˜æ•ˆ
- æ—¶ç§»è‡ªåŠ¨æ¸…ç†
- å½•åƒæŒ‰éœ€ä¿ç•™

### 4. çµæ´»é…ç½®
- æ¯ä¸ªåè®®ç‹¬ç«‹é…ç½®
- ä¿ç•™å¤©æ•°å¯è°ƒæ•´

---

## ğŸ“Š å®æ–½è®¡åˆ’

### é˜¶æ®µ 1: æ ¸å¿ƒç»„ä»¶ï¼ˆ3-4 å°æ—¶ï¼‰
- âœ… RecordingManager
- âœ… RecordingSession
- âœ… RecordingIndex
- âœ… æ–‡ä»¶å†™å…¥å’Œç®¡ç†

### é˜¶æ®µ 2: é›†æˆï¼ˆ2-3 å°æ—¶ï¼‰
- âœ… é›†æˆåˆ°å„åè®®æœåŠ¡
- âœ… é…ç½®åŠ è½½
- âœ… HTTP API

### é˜¶æ®µ 3: é«˜çº§åŠŸèƒ½ï¼ˆ2-3 å°æ—¶ï¼‰
- âœ… è‡ªåŠ¨å½’æ¡£
- âœ… è‡ªåŠ¨æ¸…ç†
- âœ… å½•åƒæ’­æ”¾

---

## ğŸ¯ æ€»ç»“

**å½•åƒç³»ç»Ÿè®¾è®¡åŸåˆ™**:
- âœ… ç‹¬ç«‹äºæ—¶ç§»ç³»ç»Ÿ
- âœ… åˆ†å±‚å­˜å‚¨ï¼ˆSSD + HDDï¼‰
- âœ… è‡ªåŠ¨å½’æ¡£å’Œæ¸…ç†
- âœ… çµæ´»é…ç½®

**ä¸æ—¶ç§»ç³»ç»Ÿçš„å…³ç³»**:
```
æ—¶ç§»å±‚ï¼š2å°æ—¶å†…ï¼Œå¿«é€Ÿè®¿é—®
å½•åƒå±‚ï¼š7-30å¤©ï¼Œé•¿æœŸå­˜å‚¨
```

**ä¸‹ä¸€æ­¥**: å¼€å§‹å®ç° RecordingManager æ ¸å¿ƒç»„ä»¶

---

**è®¾è®¡å®Œæˆæ—¶é—´**: 2026-02-19 17:50 UTC+08:00  
**çŠ¶æ€**: âœ… **è®¾è®¡å®Œæˆï¼Œå‡†å¤‡å®æ–½**
