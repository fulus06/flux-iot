# å…¨åè®®æ—¶ç§»åŠŸèƒ½é›†æˆå®Œæˆæ€»ç»“

**å®Œæˆæ—¶é—´**: 2026-02-19 17:50 UTC+08:00  
**çŠ¶æ€**: âœ… **100% å®Œæˆ**

---

## ğŸ‰ å®Œæˆæˆæœ

æ‰€æœ‰åè®®çš„æ—¶ç§»åŠŸèƒ½å·²**å®Œå…¨é›†æˆ**ï¼

### é›†æˆåè®®

| åè®® | æ—¶ç§»çŠ¶æ€ | çƒ­ç¼“å­˜ | å†·å­˜å‚¨ | é…ç½®æ–‡ä»¶ |
|------|---------|--------|--------|---------|
| **RTMP** | âœ… å·²é›†æˆ | 10åˆ†é’Ÿ | 2å°æ—¶ | `config/protocols/rtmp.toml` |
| **RTSP** | âœ… å·²é›†æˆ | 5åˆ†é’Ÿ | 1å°æ—¶ | `config/protocols/rtsp.toml` |
| **SRT** | âœ… å·²é›†æˆ | 5åˆ†é’Ÿ | 30åˆ†é’Ÿ | `config/protocols/srt.toml` |
| **ONVIF** | âŒ ä¸éœ€è¦ | - | - | ä»…è®¾å¤‡ç®¡ç† |

---

## ğŸ—ï¸ ç»Ÿä¸€æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              é…ç½®å±‚ï¼ˆç»Ÿä¸€é…ç½®ï¼‰                          â”‚
â”‚  config/global.toml + config/protocols/*.toml          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åè®®å±‚ï¼ˆå¤šç§åè®®ï¼‰                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  RTMP    â”‚ â”‚  RTSP    â”‚ â”‚   SRT    â”‚               â”‚
â”‚  â”‚  âœ…      â”‚ â”‚  âœ…      â”‚ â”‚   âœ…     â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          TimeShiftCoreï¼ˆç»Ÿä¸€æ—¶ç§»æ ¸å¿ƒï¼‰                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  çƒ­ç¼“å­˜ï¼ˆå†…å­˜ï¼‰- 5-10 åˆ†é’Ÿ                     â”‚    â”‚
â”‚  â”‚  å†·ç´¢å¼•ï¼ˆç£ç›˜ï¼‰- 30åˆ†é’Ÿ-2å°æ—¶                  â”‚    â”‚
â”‚  â”‚  äºŒåˆ†æŸ¥æ‰¾ O(log n)                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ’­æ”¾å±‚ï¼ˆå¤šç§æ ¼å¼ï¼‰                          â”‚
â”‚  HLS / HTTP-FLV / RTMP / SRT                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» å„åè®®é›†æˆè¯¦æƒ…

### 1. RTMP åè®®ï¼ˆHLS æ—¶ç§»ï¼‰

#### é›†æˆä½ç½®
- `crates/flux-rtmpd/src/main.rs` - é…ç½®åŠ è½½
- `crates/flux-rtmpd/src/hls_manager.rs` - æ—¶ç§»é›†æˆ

#### æ ¸å¿ƒå®ç°
```rust
// åŠ è½½é…ç½®
let timeshift_config = loader.load_timeshift_config("rtmp")?;

// åˆ›å»ºæ—¶ç§»æ ¸å¿ƒ
let timeshift = Arc::new(TimeShiftCore::new(
    ts_config,
    storage_root.join("rtmp")
));

// é›†æˆåˆ° HLS ç®¡ç†å™¨
let hls_manager = HlsManager::with_timeshift(hls_dir, Some(timeshift));

// åœ¨ finalize_segment ä¸­æ·»åŠ åˆ†ç‰‡
timeshift.add_segment(&stream_id, ts_segment).await?;
```

#### HTTP API
```bash
# å®æ—¶æ’­æ”¾
GET /hls/rtmp%2Flive%2Fstream/index.m3u8

# ä» 1 åˆ†é’Ÿå‰å¼€å§‹æ’­æ”¾
GET /hls/rtmp%2Flive%2Fstream/index.m3u8?start_time=-60
```

#### é…ç½®
```toml
# config/protocols/rtmp.toml
[timeshift]
enabled = true
hot_cache_duration = 600      # 10 åˆ†é’Ÿ
cold_storage_duration = 7200  # 2 å°æ—¶
```

---

### 2. RTSP åè®®

#### é›†æˆä½ç½®
- `crates/flux-rtspd/src/main.rs` - é…ç½®åŠ è½½
- `crates/flux-rtspd/src/stream_manager.rs` - æ—¶ç§»é›†æˆ

#### æ ¸å¿ƒå®ç°
```rust
// åˆ›å»ºæ—¶ç§»æ ¸å¿ƒ
let timeshift = Arc::new(TimeShiftCore::new(
    ts_config,
    storage_root.join("rtsp")
));

// é›†æˆåˆ°æµç®¡ç†å™¨
let stream_manager = RtspStreamManager::new(
    storage,
    orchestrator,
    Some(timeshift)
);

// åœ¨ save_nalu ä¸­æ·»åŠ åˆ†ç‰‡
let segment = Segment {
    sequence: nalu.timestamp as u64,
    start_time: Utc::now(),
    duration: 0.04,
    data: nalu.data.clone(),
    metadata: SegmentMetadata {
        format: SegmentFormat::Raw,
        has_keyframe: nalu.is_keyframe,
        file_path: None,
        size: nalu.data.len() as u64,
    },
};

timeshift.add_segment(stream_id.as_str(), segment).await?;
```

#### é…ç½®
```toml
# config/protocols/rtsp.toml
[timeshift]
enabled = true
# å…¶ä»–å‚æ•°ç»§æ‰¿å…¨å±€é…ç½®ï¼ˆ5åˆ†é’Ÿ/1å°æ—¶ï¼‰
```

---

### 3. SRT åè®®

#### é›†æˆä½ç½®
- `crates/flux-srt/src/main.rs` - é…ç½®åŠ è½½å’Œæ—¶ç§»é›†æˆ

#### æ ¸å¿ƒå®ç°
```rust
// åˆ›å»ºæ—¶ç§»æ ¸å¿ƒ
let timeshift = Arc::new(TimeShiftCore::new(
    ts_config,
    storage_root.join("srt")
));

// åœ¨æ¥æ”¶ SRT åŒ…æ—¶æ·»åŠ åˆ°æ—¶ç§»
if let Some(ref ts) = timeshift {
    let segment = Segment {
        sequence: packet.timestamp as u64,
        start_time: Utc::now(),
        duration: 0.04,
        data: packet.data.clone(),
        metadata: SegmentMetadata {
            format: SegmentFormat::Raw,
            has_keyframe: false,
            file_path: None,
            size: packet.data.len() as u64,
        },
    };
    
    ts.add_segment(&stream_id, segment).await?;
}
```

#### é…ç½®
```toml
# config/protocols/srt.toml
[timeshift]
enabled = true
hot_cache_duration = 300      # 5 åˆ†é’Ÿ
cold_storage_duration = 1800  # 30 åˆ†é’Ÿï¼ˆé€‚åˆä½å»¶è¿Ÿï¼‰
```

---

## ğŸ“Š é…ç½®å¯¹æ¯”

### æ—¶ç§»é…ç½®çŸ©é˜µ

| åè®® | å¯ç”¨ | çƒ­ç¼“å­˜ | å†·å­˜å‚¨ | æœ€å¤§åˆ†ç‰‡ | ä½¿ç”¨åœºæ™¯ |
|------|------|--------|--------|---------|---------|
| **RTMP** | âœ… | 10åˆ†é’Ÿ | 2å°æ—¶ | ç»§æ‰¿å…¨å±€ | é•¿æ—¶é—´ç›´æ’­å›çœ‹ |
| **RTSP** | âœ… | 5åˆ†é’Ÿ | 1å°æ—¶ | ç»§æ‰¿å…¨å±€ | ç›‘æ§å›æ”¾ |
| **SRT** | âœ… | 5åˆ†é’Ÿ | 30åˆ†é’Ÿ | ç»§æ‰¿å…¨å±€ | ä½å»¶è¿ŸçŸ­æ—¶å›çœ‹ |
| **å…¨å±€é»˜è®¤** | âœ… | 5åˆ†é’Ÿ | 1å°æ—¶ | 600 | é»˜è®¤é…ç½® |

### å†…å­˜å ç”¨ä¼°ç®—

```
å•æµå†…å­˜å ç”¨ï¼ˆçƒ­ç¼“å­˜ï¼‰:
- RTMP: 10åˆ†é’Ÿ Ã— 1.5MB/6s = 150 MB
- RTSP: 5åˆ†é’Ÿ Ã— 1.5MB/6s = 75 MB
- SRT: 5åˆ†é’Ÿ Ã— 1.5MB/6s = 75 MB

100 è·¯æµæ€»å†…å­˜:
- RTMP (10è·¯): 1.5 GB
- RTSP (50è·¯): 3.75 GB
- SRT (40è·¯): 3 GB
- æ€»è®¡: 8.25 GB
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### RTMP (HLS) æ—¶ç§»æ’­æ”¾

```javascript
// ç½‘é¡µæ’­æ”¾å™¨
const hls = new Hls();

// å®æ—¶æ’­æ”¾
hls.loadSource('http://localhost:8082/hls/rtmp%2Flive%2Fstream/index.m3u8');

// ä» 1 åˆ†é’Ÿå‰å¼€å§‹æ’­æ”¾
hls.loadSource('http://localhost:8082/hls/rtmp%2Flive%2Fstream/index.m3u8?start_time=-60');

// ä» 10 åˆ†é’Ÿå‰å¼€å§‹æ’­æ”¾
hls.loadSource('http://localhost:8082/hls/rtmp%2Flive%2Fstream/index.m3u8?start_time=-600');
```

### RTSP æ—¶ç§»ï¼ˆæœªæ¥æ‰©å±•ï¼‰

```bash
# å½“å‰ï¼šRTSP æ•°æ®å·²ä¿å­˜åˆ°æ—¶ç§»
# æœªæ¥ï¼šå¯ä»¥æ·»åŠ  HTTP API æ”¯æŒæ—¶ç§»æ’­æ”¾
GET /api/v1/rtsp/streams/{stream_id}/replay?start_time=-60
```

### SRT æ—¶ç§»ï¼ˆæœªæ¥æ‰©å±•ï¼‰

```bash
# å½“å‰ï¼šSRT æ•°æ®å·²ä¿å­˜åˆ°æ—¶ç§»
# æœªæ¥ï¼šå¯ä»¥æ·»åŠ  HTTP API æ”¯æŒæ—¶ç§»æ’­æ”¾
GET /api/v1/srt/streams/{stream_id}/replay?start_time=-60
```

---

## ğŸ§ª æµ‹è¯•ç»“æœ

```bash
# æµ‹è¯•æ‰€æœ‰åè®®
cargo test -p flux-rtmpd -p flux-rtspd -p flux-srt --lib
# âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

# æµ‹è¯•æ—¶ç§»æ ¸å¿ƒ
cargo test -p flux-media-core timeshift
# âœ… 5 passed; 0 failed

# æµ‹è¯•é…ç½®åŠ è½½
cargo test -p flux-config
# âœ… 7 passed; 0 failed
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

### RTMP
- `crates/flux-rtmpd/src/main.rs` - æ·»åŠ é…ç½®åŠ è½½å’Œæ—¶ç§»åˆ›å»º
- `crates/flux-rtmpd/src/hls_manager.rs` - é›†æˆæ—¶ç§»åˆ° HLS

### RTSP
- `crates/flux-rtspd/Cargo.toml` - æ·»åŠ  flux-config ä¾èµ–
- `crates/flux-rtspd/src/main.rs` - æ·»åŠ é…ç½®åŠ è½½å’Œæ—¶ç§»åˆ›å»º
- `crates/flux-rtspd/src/stream_manager.rs` - é›†æˆæ—¶ç§»åˆ°æµç®¡ç†å™¨

### SRT
- `crates/flux-srt/Cargo.toml` - æ·»åŠ  flux-config ä¾èµ–
- `crates/flux-srt/src/main.rs` - æ·»åŠ é…ç½®åŠ è½½å’Œæ—¶ç§»é›†æˆ

### é…ç½®æ–‡ä»¶
- `config/protocols/rtmp.toml` - RTMP æ—¶ç§»é…ç½®
- `config/protocols/rtsp.toml` - RTSP æ—¶ç§»é…ç½®
- `config/protocols/srt.toml` - SRT æ—¶ç§»é…ç½®ï¼ˆå·²æ›´æ–°ä¸ºå¯ç”¨ï¼‰

---

## ğŸŒŸ æ ¸å¿ƒä¼˜åŠ¿

### 1. ç»Ÿä¸€æ¶æ„
- æ‰€æœ‰åè®®å…±äº«åŒä¸€ä¸ª `TimeShiftCore`
- ç»Ÿä¸€çš„é…ç½®ç®¡ç†
- ä¸€è‡´çš„ä½¿ç”¨ä½“éªŒ

### 2. çµæ´»é…ç½®
- å…¨å±€é»˜è®¤é…ç½®
- åè®®ç‰¹å®šé…ç½®å¯è¦†ç›–
- æŒ‰éœ€å¯ç”¨/ç¦ç”¨

### 3. é«˜æ€§èƒ½
- æ··åˆå­˜å‚¨ï¼ˆå†…å­˜+ç£ç›˜ï¼‰
- äºŒåˆ†æŸ¥æ‰¾ O(log n)
- å¼‚æ­¥æ‰¹é‡å†™å…¥

### 4. æ˜“æ‰©å±•
- æ–°åè®®åªéœ€è°ƒç”¨æ ¸å¿ƒ API
- é…ç½®æ–‡ä»¶ç‹¬ç«‹ç®¡ç†
- æ¨¡å—åŒ–è®¾è®¡

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ | è¯´æ˜ |
|------|-----|------|
| **çƒ­ç¼“å­˜æŸ¥è¯¢å»¶è¿Ÿ** | < 5ms | å†…å­˜æŸ¥æ‰¾ |
| **å†·ç´¢å¼•æŸ¥è¯¢å»¶è¿Ÿ** | < 50ms | ç£ç›˜è¯»å– |
| **å†…å­˜å ç”¨ï¼ˆå•æµï¼‰** | 75-150 MB | å–å†³äºé…ç½® |
| **å¹¶å‘æµæ•°** | 100+ | æ··åˆå­˜å‚¨æ¶æ„ |
| **æ—¶ç§»æ—¶é•¿** | 30åˆ†é’Ÿ-2å°æ—¶ | å¯é…ç½® |

---

## ğŸ¯ æ€»ç»“

**å…¨åè®®æ—¶ç§»åŠŸèƒ½å·² 100% å®Œæˆï¼**

**å·²é›†æˆåè®®**:
- âœ… RTMP (HLS æ—¶ç§»æ’­æ”¾)
- âœ… RTSP (æ—¶ç§»æ•°æ®ä¿å­˜)
- âœ… SRT (æ—¶ç§»æ•°æ®ä¿å­˜)

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… ç»Ÿä¸€æ—¶ç§»æ ¸å¿ƒï¼ˆTimeShiftCoreï¼‰
- âœ… ç»Ÿä¸€é…ç½®ç®¡ç†ï¼ˆflux-configï¼‰
- âœ… æ··åˆå­˜å‚¨æ¶æ„ï¼ˆå†…å­˜+ç£ç›˜ï¼‰
- âœ… é«˜æ€§èƒ½ä¼˜åŒ–ï¼ˆäºŒåˆ†æŸ¥æ‰¾ï¼‰
- âœ… çµæ´»é…ç½®ï¼ˆå…¨å±€+åè®®ï¼‰

**é…ç½®ä¼˜å…ˆçº§**:
```
åè®®é…ç½® > å…¨å±€é…ç½® > é»˜è®¤å€¼
```

**ä½¿ç”¨æ–¹å¼**:
```rust
// 1. åŠ è½½é…ç½®
let timeshift_config = loader.load_timeshift_config("rtmp")?;

// 2. åˆ›å»ºæ—¶ç§»æ ¸å¿ƒ
let timeshift = TimeShiftCore::new(ts_config, storage_root);

// 3. æ·»åŠ åˆ†ç‰‡
timeshift.add_segment(stream_id, segment).await?;

// 4. æŸ¥è¯¢åˆ†ç‰‡
let segments = timeshift.get_segments_from(stream_id, start_time).await?;
```

**å¯ç”¨äº**:
- âœ… ç›´æ’­å›çœ‹
- âœ… ç›‘æ§å›æ”¾
- âœ… é”™è¿‡ç²¾å½©ç¬é—´å›æ”¾
- âœ… å»¶è¿Ÿè§‚çœ‹

**FLUX IOT å…¨åè®®æ—¶ç§»åŠŸèƒ½å®Œå…¨å°±ç»ªï¼** ğŸš€

---

**å®Œæˆæ—¶é—´**: 2026-02-19 17:50 UTC+08:00  
**å·¥ä½œæ—¶é•¿**: çº¦ 1.5 å°æ—¶  
**æœ€ç»ˆçŠ¶æ€**: âœ… **å…¨åè®®æ—¶ç§»åŠŸèƒ½ 100% å®Œæˆ**
