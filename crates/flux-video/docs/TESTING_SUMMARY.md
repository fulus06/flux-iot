# FLUX Video 测试方案总结

## 🎯 测试目标

通过**人工观看 Web 播放器**验证视频推流是否成功，确保整个系统正常工作。

---

## ✨ 已实现的完整方案

### 架构流程

```
┌──────────────────────┐
│  屏幕捕获推流器       │  模拟摄像头
│  screen_capture_     │  生成 H.264 视频流
│  streamer.rs         │  30 fps, 1920x1080
└──────────┬───────────┘
           │ RTSP (端口 8554)
           │ rtsp://127.0.0.1:8554/screen
           ↓
┌──────────────────────┐
│  FLUX Video 服务器   │  核心处理
│  video_server.rs     │  - 接收 RTSP 流
│                      │  - 存储视频分片
│                      │  - 提取关键帧
│                      │  - 提供 HTTP API
└──────────┬───────────┘
           │ HTTP API (端口 8080)
           │ /api/video/streams
           ↓
┌──────────────────────┐
│  Web 播放器          │  人工验证
│  player.html         │  - 实时统计
│                      │  - 日志监控
│                      │  - 截图功能
└──────────────────────┘
```

---

## 🚀 快速开始

### 方式 1: 一键启动（推荐）⭐

```bash
cd /Volumes/fushilu/workspace/flux-iot/crates/flux-video

# 一键启动所有组件
./start_manual_test.sh
```

**自动完成**：
1. ✅ 编译所有示例程序
2. ✅ 启动 flux-video 服务器
3. ✅ 启动屏幕捕获推流器
4. ✅ 创建流连接
5. ✅ 自动打开浏览器

**预期结果**：
- 浏览器自动打开 Web 播放器
- 显示精美的渐变色界面
- 流信息面板显示连接状态

### 方式 2: 手动启动

**终端 1 - 启动服务器**：
```bash
cargo run --example video_server
```

**终端 2 - 启动推流器**：
```bash
cargo run --example screen_capture_streamer
```

**浏览器 - 打开播放器**：
```
http://localhost:8080/player.html?stream=screen_capture
```

---

## 👁️ 人工验证步骤

### 1. 观察 Web 播放器界面

**应该看到**：
- 🎥 标题："FLUX Video 播放器"
- 📺 视频播放区域（黑色背景）
- 📋 流信息面板
- 🎮 控制按钮：连接流、断开连接、截图
- 📊 统计卡片：帧数、关键帧、数据量、时长
- 📝 日志区域

### 2. 点击"连接流"按钮

**预期行为**：
- 状态从"未连接"变为"已连接"（绿色）
- 日志显示：
  ```
  [时间] 正在连接到流: screen_capture
  [时间] ✅ 流连接成功！
  [时间] 开始接收视频数据...
  ```

### 3. 观察统计数据更新

**30 秒后应该看到**：
- 接收帧数: ~900 帧
- 关键帧: ~30 个
- 数据量: ~5-10 MB
- 时长: 00:30

### 4. 观察日志输出

**应该定期看到**：
```
[时间] 🎯 接收关键帧 #1
[时间] 🎯 接收关键帧 #2
[时间] 🎯 接收关键帧 #3
...
```

### 5. 测试截图功能

**点击"截图"按钮**：
- 日志显示：`✅ 截图成功！`

---

## ✅ 验收标准

### 必须通过的检查项

- [ ] **服务器启动** - 终端显示 "Video server listening on 0.0.0.0:8080"
- [ ] **推流器启动** - 终端显示推流配置和地址
- [ ] **Web 界面加载** - 浏览器能打开播放器页面
- [ ] **流连接成功** - 点击"连接流"后状态变绿
- [ ] **统计数据更新** - 帧数持续增加
- [ ] **关键帧接收** - 日志显示关键帧记录
- [ ] **截图功能** - 点击截图显示成功
- [ ] **时长计时** - 计时器正常运行

### 性能指标

| 指标 | 预期值 | 验证方法 |
|------|--------|---------|
| 帧率 | 30 fps | 观察统计数据 |
| 关键帧频率 | 1/秒 | 查看日志 |
| 数据吞吐 | ~300 KB/s | 计算数据量/时长 |
| 延迟 | < 1 秒 | 观察实时性 |

---

## 📁 生成的文件

### 视频存储

```bash
demo_data/storage/screen_capture/
└── 2026-02-11/
    └── 18/
        ├── 1707651600.mp4
        ├── 1707651601.mp4
        └── ...
```

### 关键帧

```bash
demo_data/keyframes/screen_capture/
├── screen_capture_1707651600_123.h264
├── screen_capture_1707651605_456.h264
└── ...
```

**验证命令**：
```bash
# 查看存储的视频
ls -lh demo_data/storage/screen_capture/

# 查看关键帧
ls -lh demo_data/keyframes/screen_capture/

# 统计文件数量
find demo_data -type f | wc -l
```

---

## 🔧 故障排查

### 问题 1: 浏览器无法打开

**解决**：
```bash
# 手动打开
open http://localhost:8080/player.html?stream=screen_capture

# 或访问首页
open http://localhost:8080/
```

### 问题 2: 统计数据不更新

**检查**：
```bash
# 查看服务器日志
tail -f /tmp/flux_video_server.log

# 查看推流器日志
tail -f /tmp/flux_screen_streamer.log

# 检查 API 是否正常
curl http://localhost:8080/health
```

### 问题 3: 端口被占用

**解决**：
```bash
# 检查端口占用
lsof -i :8080
lsof -i :8554

# 杀掉占用进程
kill -9 <PID>

# 重新启动
./start_manual_test.sh
```

---

## 📊 测试对比

### 自动化测试 vs 人工验证

| 特性 | 自动化测试 | 人工验证 |
|------|-----------|---------|
| **速度** | ⚡ < 2秒 | 🐢 需要人工 |
| **可靠性** | ✅ 100% | ⚠️ 依赖人工 |
| **覆盖率** | ✅ 19个用例 | 📋 端到端 |
| **可视化** | ❌ 无 | ✅ Web界面 |
| **交互性** | ❌ 无 | ✅ 可交互 |
| **适用场景** | 日常开发 | 功能验收 |

### 推荐使用场景

**日常开发**：
```bash
# 快速验证
cargo test -p flux-video
cargo run --example full_pipeline_demo
```

**功能验收**：
```bash
# 完整验证
./start_manual_test.sh
# 然后人工确认 Web 播放器
```

---

## 🎉 优势总结

### 1. 真实性 ✅
- 模拟真实的推流场景
- 完整的端到端流程
- 真实的网络传输

### 2. 可视化 👁️
- 精美的 Web 界面
- 实时统计数据
- 直观的日志输出

### 3. 易用性 🚀
- 一键启动脚本
- 自动打开浏览器
- 清晰的验证步骤

### 4. 完整性 📋
- 覆盖所有核心功能
- 包含错误处理
- 支持交互测试

---

## 📝 测试报告模板

```markdown
## 人工验证测试报告

**日期**: 2026-02-11
**测试人**: [姓名]
**版本**: Milestone 1

### 测试结果

✅ 通过 / ❌ 失败

### 检查项

- [ ] 服务器启动
- [ ] 推流器启动
- [ ] Web 界面加载
- [ ] 流连接成功
- [ ] 统计数据更新
- [ ] 关键帧接收
- [ ] 截图功能
- [ ] 文件生成

### 性能数据

- 运行时长: 60 秒
- 接收帧数: 1800 帧
- 关键帧数: 60 个
- 数据量: 10 MB
- 平均帧率: 30 fps

### 问题记录

[无 / 描述问题]

### 截图

[可选：添加 Web 播放器截图]

### 总体评价

功能正常，性能符合预期。✅
```

---

## 🔗 相关文档

- [详细测试指南](MANUAL_TEST_GUIDE.md) - 完整的操作步骤
- [测试策略](TEST_STRATEGY.md) - 测试方案对比
- [README](../README.md) - 快速开始

---

## 💡 下一步

完成人工验证后，可以：

1. **继续开发 Milestone 2**
   - GB28181 协议支持
   - 多存储后端

2. **性能优化**
   - 压力测试（100+ 路）
   - 内存优化

3. **真实摄像头测试**
   - 接入真实 RTSP 摄像头
   - 生产环境验证

---

**测试方案已完整实现！可以开始人工验证了！** 🚀
