# flux-rtmpd

FLUX IOT å¹³å°çš„ RTMP åª’ä½“æœåŠ¡å™¨ï¼Œæ”¯æŒ RTMP æ¨æµå’Œæ’­æ”¾ã€‚

## åŠŸèƒ½ç‰¹æ€§

### å·²å®ç° âœ…
- âœ… RTMP æœåŠ¡å™¨åŸºç¡€æ¡†æ¶ï¼ˆåŸºäº rml_rtmpï¼‰
- âœ… TCP è¿æ¥ç®¡ç†
- âœ… RTMP æ¡æ‰‹å’Œä¼šè¯ç®¡ç†
- âœ… æ¨æµè¯·æ±‚å¤„ç†ï¼ˆpublishï¼‰
- âœ… è§†é¢‘/éŸ³é¢‘æ•°æ®æ¥æ”¶
- âœ… å…ƒæ•°æ®å¤„ç†
- âœ… HTTP APIï¼ˆå¥åº·æ£€æŸ¥ã€æµåˆ—è¡¨ã€snapshotï¼‰
- âœ… é›†æˆ flux-media-coreï¼ˆå­˜å‚¨å’Œ snapshotï¼‰

### å¾…å®ç° ğŸ”„
- ğŸ”„ FLV è§£å¤ç”¨ï¼ˆH264/AAC æå–ï¼‰
- ğŸ”„ è§†é¢‘æ•°æ®å­˜å‚¨åˆ° flux-media-core
- ğŸ”„ Keyframe æå–å’Œ snapshot ç”Ÿæˆ
- ğŸ”„ RTMP æ’­æ”¾æ”¯æŒï¼ˆplayï¼‰
- ğŸ”„ HLS è½¬æ¢
- ğŸ”„ HTTP-FLV æ’­æ”¾

## å¿«é€Ÿå¼€å§‹

### ç¼–è¯‘

```bash
cargo build -p flux-rtmpd --release
```

### è¿è¡Œ

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®
cargo run -p flux-rtmpd

# è‡ªå®šä¹‰é…ç½®
cargo run -p flux-rtmpd -- \
  --rtmp-bind 0.0.0.0:1935 \
  --http-bind 0.0.0.0:8082 \
  --storage-dir ./data/rtmp/storage \
  --keyframe-dir ./data/rtmp/keyframes
```

### æµ‹è¯•

```bash
cargo test -p flux-rtmpd
```

## ä½¿ç”¨ç¤ºä¾‹

### ä½¿ç”¨ OBS æ¨æµ

1. æ‰“å¼€ OBS Studio
2. è®¾ç½® â†’ æ¨æµ
   - æœåŠ¡ï¼šè‡ªå®šä¹‰
   - æœåŠ¡å™¨ï¼š`rtmp://localhost:1935/live`
   - ä¸²æµå¯†é’¥ï¼š`test123`
3. å¼€å§‹æ¨æµ

### ä½¿ç”¨ FFmpeg æ¨æµ

```bash
ffmpeg -re -i input.mp4 -c copy -f flv rtmp://localhost:1935/live/test123
```

### æŸ¥çœ‹æ´»è·ƒæµ

```bash
curl http://localhost:8082/api/v1/rtmp/streams
```

### è·å– Snapshot

```bash
curl http://localhost:8082/api/v1/rtmp/streams/rtmp%2Flive%2Ftest123/snapshot -o snapshot.jpg
```

## API æ–‡æ¡£

### GET /health

å¥åº·æ£€æŸ¥

**å“åº”**ï¼š
```
OK
```

### GET /api/v1/rtmp/streams

åˆ—å‡ºæ‰€æœ‰æ´»è·ƒæµ

**å“åº”**ï¼š
```json
{
  "streams": [
    {
      "stream_id": "rtmp/live/test123",
      "app": "live",
      "key": "test123",
      "start_time": "2026-02-19T07:30:00Z"
    }
  ]
}
```

### GET /api/v1/rtmp/streams/:stream_id/snapshot

è·å–æµçš„ snapshot

**å‚æ•°**ï¼š
- `stream_id`: URL ç¼–ç çš„æµ IDï¼ˆä¾‹å¦‚ï¼š`rtmp%2Flive%2Ftest123`ï¼‰

**å“åº”**ï¼š
- æˆåŠŸï¼šè¿”å› JPEG å›¾åƒï¼ˆapplication/octet-streamï¼‰
- å¤±è´¥ï¼š404 Not Found

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         RTMP å®¢æˆ·ç«¯                  â”‚
â”‚    (OBS/FFmpeg/æ‘„åƒå¤´)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ RTMP (TCP 1935)
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       flux-rtmpd (RTMP Server)      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   RtmpServer                â”‚   â”‚
â”‚  â”‚   - è¿æ¥ç®¡ç†                â”‚   â”‚
â”‚  â”‚   - ä¼šè¯å¤„ç†                â”‚   â”‚
â”‚  â”‚   - äº‹ä»¶åˆ†å‘                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                      â”‚
â”‚              â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   flux-media-core           â”‚   â”‚
â”‚  â”‚   - FileSystemStorage       â”‚   â”‚
â”‚  â”‚   - SnapshotOrchestrator    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ HTTP API (8082)
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         HTTP å®¢æˆ·ç«¯                  â”‚
â”‚    (æµè§ˆå™¨/API è°ƒç”¨)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é…ç½®é€‰é¡¹

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--rtmp-bind` | `0.0.0.0:1935` | RTMP æœåŠ¡å™¨ç»‘å®šåœ°å€ |
| `--http-bind` | `0.0.0.0:8082` | HTTP API ç»‘å®šåœ°å€ |
| `--storage-dir` | `./data/rtmp/storage` | åª’ä½“å­˜å‚¨ç›®å½• |
| `--keyframe-dir` | `./data/rtmp/keyframes` | å…³é”®å¸§å­˜å‚¨ç›®å½• |

## æŠ€æœ¯æ ˆ

- **RTMP åº“**: rml_rtmp 0.8
- **HTTP æ¡†æ¶**: Axum 0.6
- **å¼‚æ­¥è¿è¡Œæ—¶**: Tokio
- **åª’ä½“å¤„ç†**: flux-media-core

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰çŠ¶æ€ |
|------|--------|----------|
| å¹¶å‘æ¨æµæ•° | 100+ | æµ‹è¯•ä¸­ |
| å»¶è¿Ÿ | < 2s | æµ‹è¯•ä¸­ |
| CPU å ç”¨ | < 30% | æµ‹è¯•ä¸­ |
| å†…å­˜å ç”¨ | < 500MB | æµ‹è¯•ä¸­ |

## å¼€å‘è·¯çº¿å›¾

### Phase 1: åŸºç¡€æ¨æµï¼ˆå½“å‰ï¼‰
- âœ… RTMP æœåŠ¡å™¨æ¡†æ¶
- âœ… è¿æ¥å’Œä¼šè¯ç®¡ç†
- âœ… åŸºç¡€äº‹ä»¶å¤„ç†
- ğŸ”„ FLV è§£å¤ç”¨
- ğŸ”„ åª’ä½“æ•°æ®å­˜å‚¨

### Phase 2: Snapshot å’Œæ’­æ”¾
- ğŸ“‹ Keyframe æå–
- ğŸ“‹ Snapshot ç”Ÿæˆ
- ğŸ“‹ RTMP æ’­æ”¾æ”¯æŒ
- ğŸ“‹ HTTP-FLV æ’­æ”¾

### Phase 3: é«˜çº§ç‰¹æ€§
- ğŸ“‹ HLS è½¬æ¢
- ğŸ“‹ è½¬ç æ”¯æŒ
- ğŸ“‹ å½•åˆ¶åŠŸèƒ½
- ğŸ“‹ æ€§èƒ½ä¼˜åŒ–

## æ•…éšœæ’æŸ¥

### RTMP è¿æ¥å¤±è´¥

æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦å¼€æ”¾ 1935 ç«¯å£ï¼š
```bash
sudo ufw allow 1935/tcp
```

### Snapshot è¿”å› 404

ç¡®ä¿ï¼š
1. æµå·²ç»æ¨é€å¹¶æ¥æ”¶åˆ°è§†é¢‘æ•°æ®
2. å·²ç»æå–åˆ°è‡³å°‘ä¸€ä¸ªå…³é”®å¸§
3. stream_id æ­£ç¡® URL ç¼–ç 

### æ—¥å¿—æŸ¥çœ‹

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
```bash
RUST_LOG=debug cargo run -p flux-rtmpd
```

## è®¸å¯è¯

ä¸ FLUX IOT é¡¹ç›®ä¿æŒä¸€è‡´

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼
