# flux-rtspd

FLUX IOT å¹³å°çš„ RTSP åª’ä½“æœåŠ¡å™¨ï¼Œæ”¯æŒ RTSP æ‹‰æµå’Œæ’­æ”¾ã€‚

## åŠŸèƒ½ç‰¹æ€§

### å·²å®žçŽ° âœ…
- âœ… RTSP æœåŠ¡å™¨åŸºç¡€æ¡†æž¶
- âœ… HTTP APIï¼ˆå¥åº·æ£€æŸ¥ã€æµåˆ—è¡¨ã€snapshotï¼‰
- âœ… é›†æˆ flux-media-coreï¼ˆå­˜å‚¨å’Œ snapshotï¼‰

### å¾…å®žçŽ° ðŸ”„
- ðŸ”„ RTSP åè®®å®žçŽ°ï¼ˆDESCRIBE/SETUP/PLAYï¼‰
- ðŸ”„ RTP/RTCP å¤„ç†
- ðŸ”„ H264/H265 è§£åŒ…
- ðŸ”„ SDP è§£æž
- ðŸ”„ RTSP è®¤è¯ï¼ˆBasic/Digestï¼‰

## å¿«é€Ÿå¼€å§‹

### ç¼–è¯‘

```bash
cargo build -p flux-rtspd --release
```

### è¿è¡Œ

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®
cargo run -p flux-rtspd

# è‡ªå®šä¹‰é…ç½®
cargo run -p flux-rtspd -- \
  --rtsp-bind 0.0.0.0:554 \
  --http-bind 0.0.0.0:8083 \
  --storage-dir ./data/rtsp/storage \
  --keyframe-dir ./data/rtsp/keyframes
```

### æµ‹è¯•

```bash
cargo test -p flux-rtspd
```

## ä½¿ç”¨ç¤ºä¾‹

### æ‹‰å– IP æ‘„åƒå¤´æµ

```bash
# ä½¿ç”¨ FFmpeg æ‹‰æµ
ffmpeg -rtsp_transport tcp -i rtsp://192.168.1.100:554/stream1 -c copy output.mp4

# ä½¿ç”¨ VLC æ’­æ”¾
vlc rtsp://192.168.1.100:554/stream1
```

### æŸ¥çœ‹æ´»è·ƒæµ

```bash
curl http://localhost:8083/api/v1/rtsp/streams
```

### èŽ·å– Snapshot

```bash
curl http://localhost:8083/api/v1/rtsp/streams/rtsp%2F192.168.1.100%2Fstream1/snapshot -o snapshot.jpg
```

## API æ–‡æ¡£

### GET /health

å¥åº·æ£€æŸ¥

**å“åº”**ï¼š
```
OK
```

### GET /api/v1/rtsp/streams

åˆ—å‡ºæ‰€æœ‰æ´»è·ƒæµ

**å“åº”**ï¼š
```json
{
  "streams": [
    {
      "stream_id": "rtsp/192.168.1.100/stream1",
      "url": "rtsp://192.168.1.100:554/stream1",
      "start_time": "2026-02-19T07:30:00Z"
    }
  ]
}
```

### GET /api/v1/rtsp/streams/:stream_id/snapshot

èŽ·å–æµçš„ snapshot

**å‚æ•°**ï¼š
- `stream_id`: URL ç¼–ç çš„æµ ID

**å“åº”**ï¼š
- æˆåŠŸï¼šè¿”å›ž JPEG å›¾åƒ
- å¤±è´¥ï¼š404 Not Found

## æž¶æž„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         IP æ‘„åƒå¤´ / RTSP æº          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ RTSP (TCP 554)
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       flux-rtspd (RTSP Client)      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   RtspClient                â”‚   â”‚
â”‚  â”‚   - DESCRIBE/SETUP/PLAY     â”‚   â”‚
â”‚  â”‚   - RTP/RTCP å¤„ç†           â”‚   â”‚
â”‚  â”‚   - H264/H265 è§£åŒ…          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                      â”‚
â”‚              â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   flux-media-core           â”‚   â”‚
â”‚  â”‚   - FileSystemStorage       â”‚   â”‚
â”‚  â”‚   - SnapshotOrchestrator    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ HTTP API (8083)
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         HTTP å®¢æˆ·ç«¯                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é…ç½®é€‰é¡¹

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜Ž |
|------|--------|------|
| `--rtsp-bind` | `0.0.0.0:554` | RTSP æœåŠ¡å™¨ç»‘å®šåœ°å€ |
| `--http-bind` | `0.0.0.0:8083` | HTTP API ç»‘å®šåœ°å€ |
| `--storage-dir` | `./data/rtsp/storage` | åª’ä½“å­˜å‚¨ç›®å½• |
| `--keyframe-dir` | `./data/rtsp/keyframes` | å…³é”®å¸§å­˜å‚¨ç›®å½• |

## æŠ€æœ¯æ ˆ

- **RTSP åè®®**: è‡ªç ”ï¼ˆåŸºäºŽ tokioï¼‰
- **HTTP æ¡†æž¶**: Axum 0.6
- **å¼‚æ­¥è¿è¡Œæ—¶**: Tokio
- **åª’ä½“å¤„ç†**: flux-media-core

## RTSP åè®®æµç¨‹

```
Client                    Server
  |                         |
  |-------- OPTIONS ------->|
  |<------- 200 OK ---------|
  |                         |
  |------- DESCRIBE ------->|
  |<-- 200 OK (SDP) --------|
  |                         |
  |-------- SETUP --------->|
  |<------- 200 OK ---------|
  |                         |
  |-------- PLAY ---------->|
  |<------- 200 OK ---------|
  |                         |
  |<====== RTP Data ========|
  |                         |
  |------- TEARDOWN ------->|
  |<------- 200 OK ---------|
```

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰çŠ¶æ€ |
|------|--------|----------|
| å¹¶å‘æ‹‰æµæ•° | 50+ | å¾…æµ‹è¯• |
| å»¶è¿Ÿ | < 2s | å¾…æµ‹è¯• |
| CPU å ç”¨ | < 20% | å¾…æµ‹è¯• |
| å†…å­˜å ç”¨ | < 300MB | å¾…æµ‹è¯• |

## å¼€å‘è·¯çº¿å›¾

### Phase 1: RTSP åè®®å®žçŽ°
- ðŸ“‹ RTSP å®¢æˆ·ç«¯æ¡†æž¶
- ðŸ“‹ DESCRIBE/SETUP/PLAY å®žçŽ°
- ðŸ“‹ SDP è§£æž
- ðŸ“‹ RTP æŽ¥æ”¶

### Phase 2: åª’ä½“å¤„ç†
- ðŸ“‹ H264 è§£åŒ…
- ðŸ“‹ H265 è§£åŒ…
- ðŸ“‹ Keyframe æå–
- ðŸ“‹ Snapshot ç”Ÿæˆ

### Phase 3: é«˜çº§ç‰¹æ€§
- ðŸ“‹ RTSP è®¤è¯
- ðŸ“‹ TCP/UDP ä¼ è¾“åˆ‡æ¢
- ðŸ“‹ æ–­çº¿é‡è¿ž
- ðŸ“‹ æ€§èƒ½ä¼˜åŒ–

## è®¸å¯è¯

ä¸Ž FLUX IOT é¡¹ç›®ä¿æŒä¸€è‡´
